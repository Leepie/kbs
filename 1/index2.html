<!DOCTYPE html>
<html lang="ms">
    <!--  
    XCode Analisis PPSA Vs PraSPM
    Tarikh Bina: 15 Jan 2026
    Script Oleh: Mr LePaK | PKP En Suhairi Hj. Shoib
    Email: mrlepak@gmail.com | 017-4611774
    -->
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>XCode - Analisis TOV T4</title>

        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <script>
            // Jadikan legend semua carta berbentuk bulat secara lalai
            if (window.Chart) {
                Chart.defaults.plugins.legend.labels.usePointStyle = true;
                Chart.defaults.plugins.legend.labels.pointStyle = 'circle';
                Chart.defaults.plugins.legend.labels.boxWidth = 12; // pilihan
                Chart.defaults.plugins.legend.labels.boxHeight = 12; // pilihan
            }
        </script>

        <style>
            /* Header */
            header {
                font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif
            }

            .pulse-dot {
                position: relative
            }

            .pulse-dot::after {
                content: "";
                position: absolute;
                inset: -6px;
                border-radius: 9999px;
                border: 2px solid rgba(34, 197, 94, .4);
                animation: pulse 1.6s cubic-bezier(.4, 0, .2, 1) infinite
            }

            @keyframes pulse {
                0% {
                    transform: scale(.6);
                    opacity: .9
                }

                70% {
                    transform: scale(1.4);
                    opacity: 0
                }

                100% {
                    transform: scale(1.4);
                    opacity: 0
                }
            }

            /* Tab menu cards */
            .analysis-tabs .card-hover {
                height: 5.5rem;
                border: 1px solid #e5e7eb;
                border-radius: 14px;
                background: #fff;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
                box-shadow: 0 1px 2px rgba(16, 24, 40, .06);
                transition: transform .08s ease, box-shadow .15s ease;
            }

            .analysis-tabs .card-hover:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 20px rgba(16, 24, 40, .12)
            }

            .analysis-tabs .tab-active {
                background: linear-gradient(135deg, #3b82f6 0%, #4f46e5 100%) !important;
                color: #fff !important;
                border-color: transparent !important;
                box-shadow: 0 12px 24px rgba(79, 70, 229, .26);
            }

            .analysis-tabs .card-hover .text-lg {
                font-size: 22px;
                line-height: 1
            }

            .analysis-tabs .card-hover .text-sm {
                font-size: 15px;
                font-weight: 400
            }

            /* Kawalan borang/kad */
            body {
                background: #f8fafc;
                color: #111827;
                font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif
            }

            .field-label {
                font-size: .95rem;
                color: #374151;
                font-weight: 600
            }

            .select-like {
                width: 100%;
                border: 1px solid #e5e7eb;
                border-radius: 0.75rem;
                padding: 0.75rem 1rem;
                font-size: .95rem;
                background: #fff;
                box-shadow: 0 1px 2px rgba(16, 24, 40, .04);
                outline: none;
                transition: border-color .15s, box-shadow .15s;
            }

            .select-like:focus {
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, .25)
            }

            .btn-primary {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                padding: .875rem 1rem;
                border-radius: .9rem;
                font-weight: 700;
                color: #fff;
                background: #3b5bfd;
                box-shadow: 0 1px 3px rgba(59, 91, 253, .25);
                transition: transform .06s, filter .15s, background .15s;
            }

            .btn-primary:hover {
                filter: brightness(1.05)
            }

            .btn-primary:active {
                transform: scale(.985)
            }

            .container-max {
                max-width: 1200px;
                margin-left: auto;
                margin-right: auto
            }

            /* Carta tetap */
            .chart-fixed {
                height: 320px
            }

            @media (max-width:1024px) {
                .chart-fixed {
                    height: 300px
                }
            }

            @media (max-width:640px) {
                .chart-fixed {
                    height: 260px
                }
            }

            #gradeChart {
                width: 100% !important;
                height: 100% !important;
                display: block
            }

            /* Butang sort (diguna semula) */
            .sort-btn {
                display: inline-flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                margin-left: 6px;
                cursor: pointer
            }

            .sort-btn svg {
                width: 12px;
                height: 12px;
                fill: #d1d5db
            }

            .sort-btn.asc .up {
                fill: #fff
            }

            .sort-btn.desc .down {
                fill: #fff
            }

            /* ‚úÖ Sticky aktif hanya di desktop (min-width:1024px) */
            @media (min-width: 1024px) {

                .sticky-card,
                .ls-sticky-card,
                .cz-sticky-card {
                    position: sticky !important;
                    top: 0 !important;
                    z-index: 40 !important;
                    /* pastikan atas */
                }
            }

            /* ‚úÖ Sticky disable di telefon/tablet kecil (max-width:1023px) */
            @media (max-width: 1023px) {

                .sticky-card,
                .ls-sticky-card,
                .cz-sticky-card {
                    position: static !important;
                }
            }

            @media (max-width: 640px) {
                .table-wrapper::before {
                    content: "üëâ Slaid ke tepi untuk lihat semua data";
                    display: block;
                    font-size: 0.85rem;
                    color: #6b7280;
                    margin-bottom: 4px;
                }
            }

            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                /* smooth scroll di iOS */
            }
        </style>
        <style>
            /* Pilihan: gradient halus & glass card */
            .bg-hero {
                background: radial-gradient(1200px 600px at 10% 0%, rgba(59, 130, 246, .15), transparent 60%),
                    radial-gradient(900px 500px at 90% 10%, rgba(168, 85, 247, .12), transparent 60%),
                    linear-gradient(180deg, #f8fafc, #eef2ff);
            }

            @media (prefers-color-scheme: dark) {
                .bg-hero {
                    background: radial-gradient(1200px 600px at 10% 0%, rgba(59, 130, 246, .25), transparent 60%),
                        radial-gradient(900px 500px at 90% 10%, rgba(168, 85, 247, .22), transparent 60%),
                        linear-gradient(180deg, #0b1020, #0a0f1d);
                }
            }

            .glass {
                backdrop-filter: saturate(140%) blur(10px);
                -webkit-backdrop-filter: saturate(140%) blur(10px);
                background: rgba(255, 255, 255, .72);
            }

            @media (prefers-color-scheme: dark) {
                .glass {
                    background: rgba(13, 17, 23, .6);
                }
            }
        </style>

    </head>

    <body class="bg-gray-50 text-gray-800">
        
        <div id="loginOverlay" class="fixed inset-0 bg-hero flex items-center justify-center z-50">
            <div class="glass shadow-xl rounded-2xl p-8 w-96 text-center">
                <h2 class="font-bold mb-4 text-xl text-gray-800 dark:text-gray-100">Masukkan Kod</h2>
                <input type="password" id="kodSekolah" placeholder="Contoh: TOVT4" class="border rounded-lg w-full px-3 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <button onclick="checkKod()" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg w-full py-2 font-semibold">
                    Masuk
                </button>
                <p id="msg" class="text-red-600 text-sm mt-3"></p>
            </div>
        </div>

        <!-- ================= KANDUNGAN SISTEM ================= -->
        <div id="content" style="display:none;"> 
            <!-- Semua kod analisis PPSA vs PraSPM -->

            <!-- =================== HEADER =================== -->
            <header class="bg-white shadow-sm border-b">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <img src="https://leepie.github.io/kbs/KBs-LOGO-FINAL.png" alt="SMK Kampung Bahagia" class="h-16 w-16 object-contain rounded-full border" />
                            <div>
                                <h1 class="text-2xl font-bold text-gray-900">PPSA TOV T4</h1>
                                <p class="text-sm text-gray-600">TOVT4</p>
                                <p class="text-sm font-medium text-gray-800">SMK KPG BAHAGIA</p>
                                <div class="flex items-center space-x-2 mt-1">
                                    <div class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></div>
                                    <span class="text-xs text-gray-600">Data TOV T4 / 2025</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex space-x-6">
                            <div class="text-center">
                                <div class="text-3xl font-bold text-blue-600" id="gpsValue">-</div>
                                <div class="text-sm text-gray-600">Gred Purata Sekolah</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-green-600" id="layakSijilValue">-</div>
                                <div class="text-sm text-gray-600">Peratus Layak Sijil</div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- =================== MENU TAB =================== -->
            <div class="analysis-tabs max-w-[1200px] mx-auto px-4 pt-6 pb-1">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-1">
                    <button onclick="switchTab('keseluruhan')" id="tab-keseluruhan" class="tab-active card-hover p-4 rounded-lg text-center transition-all">
                        <div class="text-lg mb-1">üìä</div>
                        <div class="text-sm">Analisis Keseluruhan</div>
                    </button>
                    <button onclick="switchTab('matapelajaran')" id="tab-matapelajaran" class="bg-white card-hover p-4 rounded-lg text-center transition-all">
                        <div class="text-lg mb-1">üìö</div>
                        <div class="text-sm">Analisis Mata Pelajaran</div>
                    </button>
                    <button onclick="switchTab('layaksijil')" id="tab-layaksijil" class="bg-white card-hover p-4 rounded-lg text-center transition-all">
                        <div class="text-lg mb-1">üéì</div>
                        <div class="text-sm">Analisis Layak Sijil</div>
                    </button>
                    <button onclick="switchTab('combatzone')" id="tab-combatzone" class="bg-white card-hover p-4 rounded-lg text-center transition-all">
                        <div class="text-lg mb-1">‚ö†Ô∏è</div>
                        <div class="text-sm">Analisis Combat Zone</div>
                    </button>
                    <button onclick="switchTab('individu')" id="tab-individu" class="bg-white card-hover p-4 rounded-lg text-center transition-all">
                        <div class="text-lg mb-1">üë§</div>
                        <div class="text-sm">Analisis Individu</div>
                    </button>
                </div>
            </div>

            <!-- =================== TAB 1: Analisis Keseluruhan  =================== -->
            <!-- Sticky card -->
            <section data-tab-panel="keseluruhan" class="sticky-card bg-white/80 backdrop-blur border-b border-gray-100">
                <div class="container-max px-4 py-4">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 px-4 sm:px-6 py-5">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-5">
                            <span>üìä</span> Analisis Keseluruhan
                        </h2>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="kelasFilter" class="field-label">Kelas</label>
                                <select id="kelasFilter" class="select-like mt-1">
                                    <option value="">Pilih Kelas</option>
                                </select>
                            </div>
                            <div>
                                <label for="bidangFilter" class="field-label">Bidang</label>
                                <select id="bidangFilter" class="select-like mt-1">
                                    <option value="Semua Bidang">Semua Bidang</option>
                                    <option value="Bahasa">Bahasa</option>
                                    <option value="Kemanusiaan">Kemanusiaan</option>
                                    <option value="Sains & Matematik">Sains & Matematik</option>
                                    <option value="Teknik & Vokasional">Teknik & Vokasional</option>
                                </select>
                            </div>
                            <div>
                                <label for="topStudentsCount" class="field-label">Murid Terbaik</label>
                                <select id="topStudentsCount" class="select-like mt-1">
                                    <option value="5">Top 5</option>
                                    <option value="10">Top 10</option>
                                    <option value="20">Top 20</option>
                                </select>
                            </div>
                            <div>
                                <button id="btnJana" class="btn-primary mt-6 md:mt-0" onclick="generateOverallAnalysis()" disabled>Jana Analisis</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- KPI, Murid Terbaik, Carta & Jadual Subjek -->
            <section class="container-max px-4 pt-4 pb-6 hidden" data-tab-panel="keseluruhan" data-reveal>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                    <div class="rounded-2xl border border-blue-100 bg-blue-50 shadow-sm h-[5.5rem]">
                        <div class="h-full px-6 flex items-center justify-between">
                            <div>
                                <p class="text-blue-800/80 text-sm">Gred Purata</p>
                                <div id="kpiGPS" class="text-blue-800 text-3xl font-extrabold leading-tight">--</div>
                            </div>
                            <div class="text-2xl">üìä</div>
                        </div>
                    </div>
                    <div class="rounded-2xl border border-green-100 bg-green-50 shadow-sm h-[5.5rem]">
                        <div class="h-full px-6 flex items-center justify-between">
                            <div>
                                <p class="text-green-800/90 text-sm">Layak Sijil</p>
                                <div id="kpiLayak" class="text-green-800 text-3xl font-extrabold leading-tight">--</div>
                            </div>
                            <div class="text-2xl">üéì</div>
                        </div>
                    </div>
                    <div class="rounded-2xl border border-purple-100 bg-purple-50 shadow-sm h-[5.5rem]">
                        <div class="h-full px-6 flex items-center justify-between">
                            <div>
                                <p class="text-purple-800/90 text-sm">Jumlah Murid</p>
                                <div id="kpiMurid" class="text-purple-800 text-3xl font-extrabold leading-tight">--</div>
                            </div>
                            <div class="text-2xl">üë•</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="container-max px-4 pb-6 hidden" data-tab-panel="keseluruhan" data-reveal>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                    <div class="px-5 sm:px-6 py-3 flex items-center gap-2">
                        <span class="text-2xl">üèÜ</span>
                        <h2 class="text-xl font-semibold text-gray-800">Murid Terbaik</h2>
                    </div>
                    <div class="table-wrapper">
                        <table class="w-full text-[14px] border-collapse">
                            <thead>
                                <tr class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white">
                                    <th class="px-2.5 py-2 text-center">Ked.</th>
                                    <th class="px-2.5 py-2 text-center">Nama</th>
                                    <th class="px-2.5 py-2 text-center">Kelas</th>
                                    <th class="px-2.5 py-2 text-center">GP Murid</th>
                                    <th class="px-2.5 py-2 text-center">A+</th>
                                    <th class="px-2.5 py-2 text-center">A</th>
                                    <th class="px-2.5 py-2 text-center">A-</th>
                                    <th class="px-2.5 py-2 text-center">B+</th>
                                    <th class="px-2.5 py-2 text-center">B</th>
                                    <th class="px-2.5 py-2 text-center">C+</th>
                                    <th class="px-2.5 py-2 text-center">C</th>
                                </tr>
                            </thead>
                            <tbody id="muridTerbaikBody" class="divide-y"></tbody>
                        </table>
                    </div>
                    <div class="h-3"></div>
                </div>
            </section>

            <section class="container-max px-4 pb-6 hidden" data-tab-panel="keseluruhan" data-reveal>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                    <div class="px-5 sm:px-6 py-3 flex items-center gap-2">
                        <span class="text-2xl">üìà</span>
                        <h2 class="text-xl font-semibold text-gray-800">Carta Taburan Gred</h2>
                    </div>
                    <div class="px-3 pb-4">
                        <div class="chart-fixed">
                            <canvas id="gradeChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- =================== TAB 2  =================== :-->

            <section class="container-max px-4 pb-10 hidden" data-tab-panel="keseluruhan" data-reveal>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100">

                    <!-- üî∞ Tajuk & Butang Cetak Rumusan -->
                    <div class="px-5 sm:px-6 py-3 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">üìö</span>
                            <h2 class="text-xl font-semibold text-gray-800">Jadual Analisis Mata Pelajaran</h2>
                        </div>

                        <!-- üñ®Ô∏è Butang Cetak (ikon gaya Combat Zone) -->
                        <button onclick="printRumusan()" title="Cetak Rumusan" class="text-gray-500 hover:text-indigo-600 transition-transform duration-200 hover:scale-110">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 9V2h12v7m-3 4h3a2 2 0 012 2v5h-4v-3H8v3H4v-5a2 2 0 012-2h3m0 0V9h6v4H9z" />
                            </svg>
                        </button>
                    </div>

                    <!-- üßÆ Jadual Analisis Subjek -->
                    <div class="table-wrapper">
                        <table class="w-full text-[14px] border-collapse whitespace-nowrap min-w-[1100px]">
                            <thead>
                                <tr class="bg-green-600 text-white">
                                    <th class="px-2.5 py-2 text-center">Mata Pelajaran</th>
                                    <th class="px-2.5 py-2 text-center">Hadir</th>
                                    <th class="px-2.5 py-2 text-center">TH</th>
                                    <th class="px-2.5 py-2 text-center">A+</th>
                                    <th class="px-2.5 py-2 text-center">A</th>
                                    <th class="px-2.5 py-2 text-center">A-</th>
                                    <th class="px-2.5 py-2 text-center">B+</th>
                                    <th class="px-2.5 py-2 text-center">B</th>
                                    <th class="px-2.5 py-2 text-center">C+</th>
                                    <th class="px-2.5 py-2 text-center">C</th>
                                    <th class="px-2.5 py-2 text-center">D</th>
                                    <th class="px-2.5 py-2 text-center">E</th>
                                    <th class="px-2.5 py-2 text-center">G</th>
                                    <th class="px-2.5 py-2 text-center">%Lulus</th>
                                    <th class="px-2.5 py-2 text-center">%Gagal</th>
                                    <th class="px-2.5 py-2 text-center">
                                        GPMP
                                        <span id="gpmpSortBtn" class="sort-btn align-middle">
                                            <svg class="up" viewBox="0 0 24 24">
                                                <path d="M7 14l5-5 5 5z" />
                                            </svg>
                                            <svg class="down" viewBox="0 0 24 24">
                                                <path d="M7 10l5 5 5-5z" />
                                            </svg>
                                        </span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="analisisSubjekBody" class="divide-y"></tbody>
                        </table>
                    </div>

                    <div class="h-3"></div>
                </div>
            </section>

            <!-- =================== TAB 1  =================== -->
            <!-- üíæ PAPARAN KHAS UNTUK CETAK (A4 LANDSCAPE + FORMAT) -->
            <section id="rumusanCetak" style="display:none;">
                <!-- ‚ö†Ô∏è Buang header sekolah di sini! Tajuk & logo dijana semasa print -->
                <table style="width:100%; border-collapse:collapse; font-size:10px;">
                    <thead>
                        <tr style="background:#33691E; color:#fff;">
                            <th rowspan="2" style="border:1px solid #000; width:18%; padding:5px;">SUBJEK</th>
                            <th colspan="11" style="border:1px solid #000; text-align:center; background:#274f5b;">GRED</th>
                            <th colspan="3" style="border:1px solid #000; text-align:center; background:#255391;">BILANGAN CALON</th>
                            <th colspan="3" style="border:1px solid #000; text-align:center; background:#331d70;">KEPUTUSAN MATA PELAJARAN</th>
                            <th rowspan="2" style="border:1px solid #000; background:#8E24AA; color:#fff;">GPMP</th>
                        </tr>
                        <tr>
                            <th style="border:1px solid #000; background:#54808b;">A+</th>
                            <th style="border:1px solid #000; background:#54808b;">A</th>
                            <th style="border:1px solid #000; background:#54808b;">A-</th>
                            <th style="border:1px solid #000; background:#54808b;">B+</th>
                            <th style="border:1px solid #000; background:#54808b;">B</th>
                            <th style="border:1px solid #000; background:#54808b;">C+</th>
                            <th style="border:1px solid #000; background:#54808b;">C</th>
                            <th style="border:1px solid #000; background:#54808b;">D</th>
                            <th style="border:1px solid #000; background:#54808b;">E</th>
                            <th style="border:1px solid #000; background:#54808b;">G</th>
                            <th style="border:1px solid #000; background:#54808b;">TH</th>
                            <th style="border:1px solid #000; background:#5084c0;">JUMLAH</th>
                            <th style="border:1px solid #000; background:#5084c0;">HADIR</th>
                            <th style="border:1px solid #000; background:#5084c0;">% HADIR</th>
                            <th style="border:1px solid #000; background:#624fa1;">LULUS</th>
                            <th style="border:1px solid #000; background:#624fa1;">GAGAL</th>
                            <th style="border:1px solid #000; background:#624fa1;">% LULUS</th>
                        </tr>
                    </thead>
                    <tbody id="rumusanBody"></tbody>
                    <tfoot id="rumusanFoot"></tfoot>
                </table>

                <div class="footer" style="text-align:center; font-size:7px; color:#333; margin-top:30px;">
                    Dicetak secara automatik daripada Sistem Analisis PPSA vs PraSPM<br>
                    ¬© 2025 Hakcipta Terpelihara XCode Mr LePaK
                </div>
            </section>

            <script>
                function janaRumusanCetak() {
                    const sourceRows = document.querySelectorAll("#analisisSubjekBody tr");
                    const tbody = document.getElementById("rumusanBody");
                    const tfoot = document.getElementById("rumusanFoot");
                    tbody.innerHTML = "";
                    tfoot.innerHTML = "";

                    const total = Array(18).fill(0);
                    const toNum = (s) => parseFloat(String(s).replace(/[^\d.-]/g, "")) || 0;

                    sourceRows.forEach((row, index) => {
                        const c = row.querySelectorAll("td");
                        if (c.length < 16) return;

                        let subjek = (c[0]?.innerText || "").trim();
                        subjek = subjek.replace(/^\[[A-Z]+\]\s*-\s*/g, "").trim();

                        const aPlus = toNum(c[3]?.innerText);
                        const a = toNum(c[4]?.innerText);
                        const aMin = toNum(c[5]?.innerText);
                        const bPlus = toNum(c[6]?.innerText);
                        const b = toNum(c[7]?.innerText);
                        const cPlus = toNum(c[8]?.innerText);
                        const cc = toNum(c[9]?.innerText);
                        const d = toNum(c[10]?.innerText);
                        const e = toNum(c[11]?.innerText);
                        const g = toNum(c[12]?.innerText);
                        const th = toNum(c[2]?.innerText);
                        const jumlah = toNum(c[1]?.innerText);
                        const hadir = jumlah - th;
                        const perHadir = jumlah ? ((hadir / jumlah) * 100).toFixed(2) + "%" : "";
                        const lulus = hadir - g;
                        const gagal = g;
                        const perLulus = jumlah ? ((lulus / jumlah) * 100).toFixed(1) + "%" : "";
                        const gpmp = c[15]?.innerText || "";

                        const vals = [aPlus, a, aMin, bPlus, b, cPlus, cc, d, e, g, th, jumlah, hadir, lulus, gagal];
                        vals.forEach((v, i) => total[i] += v);

                        const bgColor = index % 2 === 0 ? "#ffffff" : "#f7f7f7";
                        const tr = document.createElement("tr");
                        tr.style.background = bgColor;
                        tr.innerHTML = `
                  <td style="text-align:left; padding-left:6px;">${subjek}</td>
                  <td>${aPlus}</td><td>${a}</td><td>${aMin}</td><td>${bPlus}</td><td>${b}</td>
                  <td>${cPlus}</td><td>${cc}</td><td>${d}</td><td>${e}</td><td>${g}</td><td>${th}</td>
                  <td>${jumlah}</td><td>${hadir}</td><td>${perHadir}</td>
                  <td>${lulus}</td><td>${gagal}</td><td>${perLulus}</td><td>${gpmp}</td>
                `;
                        tbody.appendChild(tr);
                    });

                    const jumlahSemua = document.createElement("tr");
                    jumlahSemua.style.background = "#dcedc8";
                    jumlahSemua.style.fontWeight = "bold";
                    jumlahSemua.innerHTML = `
                <td style="text-align:left; padding-left:6px;">SEMUA SUBJEK</td>
                ${total.slice(0,11).map(v=>`<td>${v}</td>`).join("")}
                <td>${total[11]}</td>
                <td>${total[12]}</td>
                <td>${((total[12]/total[11])*100).toFixed(2)}%</td>
                <td>${total[13]}</td>
                <td>${total[14]}</td>
                <td>${((total[13]/total[11])*100).toFixed(2)}%</td>
                <td>5.29</td>
              `;
                    tfoot.appendChild(jumlahSemua);
                }

                function printRumusan() {
                    janaRumusanCetak();

                    const section = document.getElementById("rumusanCetak");
                    const content = section.innerHTML;

                    const tarikhCetak = new Date().toLocaleDateString('ms-MY', {
                        day: '2-digit',
                        month: 'long',
                        year: 'numeric'
                    });

                    const printWindow = window.open("", "_blank", "width=1200,height=800");
                    printWindow.document.open();
                    printWindow.document.write(`
              <html>
                <head>
                  <title>Rumusan Pencapaian Mengikut Subjek</title>
                  <style>
                    @page { size: A4 landscape; margin: 8mm; }
                    body { font-family: Arial, sans-serif; font-size: 10px; background: #fff; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid #000; padding: 3px 4px; text-align: center; }
                    tbody td:first-child, tfoot td:first-child { text-align:left; padding-left:6px; }
                    thead tr:first-child { background:#33691E; color:#fff; }
                    thead tr:nth-child(2) { background:#1E88E5; color:#fff; }
                    tbody tr:nth-child(odd) { background:#ffffff; }
                    tbody tr:nth-child(even) { background:#f7f7f7; }
                    tfoot td { background:#dcedc8; font-weight:bold; }
            
                    .slip-header { text-align:center; margin-bottom:6px; }
                    .slip-header img { width:70px; margin-bottom:5px; }
                   
                    .slip-header p {
                      margin: 1px 0;        /* üîπ Kurangkan jarak atas/bawah */
                      line-height: 0.6;      /* üîπ Rapatkan jarak antara baris */
                      font-size: 12px;
                    }
            
                    /* Tambah ini */
                    .slip-header p b {
                      display: block;
                      font-size: 14px;     /* üîπ Besarkan ikut cita rasa ‚Äî boleh cuba 15px atau 16px */
                      letter-spacing: 0.5px;
                    }
                    
                    /* Baris alamat bawahnya kekal kecil */
                    .slip-header p {
                      margin: 2px 0;
                      font-size: 11px;
                    }
            
                    h2 { text-align:center; font-weight:bold; font-size:12px; margin:8px 0 2px 0; }
                    .tarikh-cetak { text-align:center; font-size:9px; color:#333; margin-bottom:10px; }
                    hr { border:none; border-top:1px solid #ccc; margin:8px 0 10px 0; }
            
                    .footer { text-align:center; font-size:7px; color:#333; margin-top:15px; }
                  </style>
                </head>
                <body>
                  <div class="slip-header">
                    <img src="https://leepie.github.io/kbs/KBs-LOGO-FINAL.png" alt="Logo">
                    <p><b>SEKOLAH MENENGAH KEBANGSAAN KAMPUNG BAHAGIA</b><br>
                    TELUK INTAN, PERAK DR</p>
                  </div>
            
                  <h2>RUMUSAN PENCAPAIAN MENGIKUT SUBJEK</h2>
                  <div class="tarikh-cetak">Cetakan: ${tarikhCetak}</div>
                  <hr>
            
                  ${content}
                </body>
              </html>`);
                    printWindow.document.close();

                    printWindow.onload = () => {
                        printWindow.focus();
                        printWindow.print();
                        // setTimeout(() => printWindow.close(), 800);
                    };
                }
            </script>

            <style>
                @page {
                    size: A4 landscape;
                    margin: 8mm;
                }

                @media print {

                    /* ==========================
                 Umum & Asas
                 ========================== */
                    html,
                    body {
                        width: 297mm;
                        height: 210mm;
                        margin: 0;
                        padding: 0;
                        background: #fff;
                        font-family: Arial, sans-serif;
                    }

                    /* ==========================
                 Paparan hanya #rumusanCetak
                 ========================== */
                    body>*:not(#rumusanCetak) {
                        display: none !important;
                    }

                    #rumusanCetak {
                        display: block !important;
                        padding: 15px 20px;
                    }

                    /* ==========================
                 Tajuk
                 ========================== */
                    #rumusanCetak h2 {
                        text-align: center;
                        margin-bottom: 10px;
                        font-size: 18px;
                        font-weight: bold;
                        color: #212121;
                    }

                    /* ==========================
                 Jadual
                 ========================== */
                    #rumusanCetak table {
                        width: 100%;
                        border-collapse: collapse;
                        table-layout: fixed;
                        font-size: 10px;
                    }

                    #rumusanCetak th,
                    #rumusanCetak td {
                        border: 0.5pt solid #000;
                        padding: 3px 5px;
                        text-align: center;
                    }

                    th[rowspan="2"] {
                        vertical-align: middle;
                    }

                    tbody td:first-child {
                        text-align: left;
                        padding-left: 6px;
                    }

                    /* ==========================
                 Warna Header
                 ========================== */
                    #rumusanCetak thead tr:first-child {
                        background: #33691E;
                        /* Hijau gelap */
                        color: #fff;
                    }

                    #rumusanCetak thead tr:nth-child(2) th:nth-child(1n+2):nth-child(-n+10) {
                        background: #1E88E5;
                        /* GRED (A+ hingga E) */
                        color: #fff;
                    }

                    #rumusanCetak thead tr:nth-child(2) th:nth-child(11),
                    #rumusanCetak thead tr:nth-child(2) th:nth-child(12),
                    #rumusanCetak thead tr:nth-child(2) th:nth-child(13) {
                        background: #1976D2;
                        /* BIL. CALON */
                        color: #fff;
                    }

                    #rumusanCetak thead tr:nth-child(2) th:nth-child(14),
                    #rumusanCetak thead tr:nth-child(2) th:nth-child(15),
                    #rumusanCetak thead tr:nth-child(2) th:nth-child(16) {
                        background: #4527A0;
                        /* KEPUTUSAN MATA PELAJARAN */
                        color: #fff;
                    }

                    #rumusanCetak thead tr:first-child th:last-child,
                    #rumusanCetak thead tr:nth-child(2) th:last-child {
                        background: #8E24AA;
                        /* GPMP */
                        color: #fff;
                    }

                    /* ==========================
                 Badan & Jumlah
                 ========================== */
                    tbody tr:nth-child(odd) {
                        background: #ffffff;
                    }

                    tbody tr:nth-child(even) {
                        background: #f9f9f9;
                    }

                    #rumusanCetak tfoot td {
                        background: #e8f5e9;
                        font-weight: bold;
                        text-align: center;
                    }
                }
            </style>
            <!-- Tamat Tambahan -->
            <!-- =================== TAB 2: Analisis Mata Pelajaran =================== -->
            <section data-tab-panel="matapelajaran" class="sticky-card bg-white/80 backdrop-blur border-b border-gray-100 hidden">
                <div class="container-max px-4 py-4">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 px-4 sm:px-6 py-5">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-5">
                            <span>üìä</span> Analisis Mata Pelajaran
                        </h2>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="kelasFilterMP" class="field-label">Kelas</label>
                                <select id="kelasFilterMP" class="select-like mt-1">
                                    <option value="">Pilih Kelas</option>
                                </select>
                            </div>

                            <div class="md:col-span-2">
                                <label for="subjekFilter" class="field-label">Subjek</label>
                                <select id="subjekFilter" class="select-like mt-1">
                                    <option value="">Pilih Subjek</option>
                                </select>
                            </div>

                            <div>
                                <button id="btnJanaTab2" class="btn-primary mt-6 md:mt-0" onclick="generateSubjectCards()" disabled>
                                    Jana Analisis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Kad Jadual Pecahan Kelas -->
            <section class="container-max px-4 pb-8 hidden" data-tab-panel="matapelajaran" id="pecahanKelasCard">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                    <div class="px-5 sm:px-6 py-3 flex items-center gap-2">
                        <span class="text-2xl">üìä</span>
                        <h2 class="text-xl font-semibold text-gray-800">Jadual Pecahan Kelas</h2>
                    </div>
                    <div class="table-wrapper">
                        <table class="w-full text-[14px] border-collapse whitespace-nowrap min-w-[1100px]">
                            <thead>
                                <tr class="bg-gradient-to-r from-indigo-500 to-blue-600 text-white">
                                    <th class="px-2.5 py-2 text-center">Kelas</th>
                                    <th class="px-2.5 py-2 text-center">Hadir</th>
                                    <th class="px-2.5 py-2 text-center">TH</th>
                                    <th class="px-2.5 py-2 text-center">A+</th>
                                    <th class="px-2.5 py-2 text-center">A</th>
                                    <th class="px-2.5 py-2 text-center">A-</th>
                                    <th class="px-2.5 py-2 text-center">B+</th>
                                    <th class="px-2.5 py-2 text-center">B</th>
                                    <th class="px-2.5 py-2 text-center">C+</th>
                                    <th class="px-2.5 py-2 text-center">C</th>
                                    <th class="px-2.5 py-2 text-center">D</th>
                                    <th class="px-2.5 py-2 text-center">E</th>
                                    <th class="px-2.5 py-2 text-center">G</th>
                                    <th class="px-2.5 py-2 text-center">%Lulus</th>
                                    <th class="px-2.5 py-2 text-center">%Gagal</th>
                                    <th class="px-2.5 py-2 text-center">
                                        GPMP
                                        <span id="gpmpKelasSortBtn" class="sort-btn align-middle">
                                            <svg class="up" viewBox="0 0 24 24">
                                                <path d="M7 14l5-5 5 5z" />
                                            </svg>
                                            <svg class="down" viewBox="0 0 24 24">
                                                <path d="M7 10l5 5 5-5z" />
                                            </svg>
                                        </span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="pecahanKelasBody" class="divide-y"></tbody>
                        </table>
                    </div>
                    <div class="h-3"></div>
                </div>
            </section>

            <!-- Kad Senarai Murid (DIKEMAS KINI: opsyen per halaman + sort Markah & Gred) -->
            <section class="container-max px-4 pb-10 hidden" data-tab-panel="matapelajaran" id="senaraiMuridCard">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                    <div class="px-5 sm:px-6 py-3 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">üë•</span>
                            <h2 class="text-xl font-semibold text-gray-800">Senarai Murid</h2>
                        </div>
                        <div>
                            <!-- Tambah: 5,10,15,20,25, Semua -->
                            <select id="senaraiPageSize" class="border rounded-lg px-3 py-2 text-sm">
                                <option value="5" selected>5 per halaman</option>
                                <option value="10">10 per halaman</option>
                                <option value="15">15 per halaman</option>
                                <option value="20">20 per halaman</option>
                                <option value="25">25 per halaman</option>
                                <option value="ALL">Semua</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-wrapper">
                        <table class="w-full text-[14px] border-collapse whitespace-nowrap">
                            <thead>
                                <tr class="bg-gradient-to-r from-purple-500 to-pink-500 text-white">
                                    <th class="px-3 py-2 text-center">Bil</th>
                                    <th class="px-3 py-2 text-center">Nama</th>
                                    <th class="px-3 py-2 text-center">Kelas</th>
                                    <th class="px-3 py-2 text-center">
                                        Markah
                                        <!-- 3-laras sort Markah -->
                                        <span id="senaraiMarkahSortBtn" class="sort-btn inline-flex align-middle ml-1">
                                            <svg class="up" viewBox="0 0 24 24">
                                                <path d="M7 14l5-5 5 5z" />
                                            </svg>
                                            <svg class="down" viewBox="0 0 24 24">
                                                <path d="M7 10l5 5 5-5z" />
                                            </svg>
                                        </span>
                                    </th>
                                    <th class="px-3 py-2 text-center">
                                        Gred
                                        <!-- 3-laras sort Gred -->
                                        <span id="senaraiGredSortBtn" class="sort-btn inline-flex align-middle ml-1">
                                            <svg class="up" viewBox="0 0 24 24">
                                                <path d="M7 14l5-5 5 5z" />
                                            </svg>
                                            <svg class="down" viewBox="0 0 24 24">
                                                <path d="M7 10l5 5 5-5z" />
                                            </svg>
                                        </span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="senaraiMuridBody" class="divide-y"></tbody>
                        </table>
                    </div>

                    <div class="flex flex-col sm:flex-row items-center justify-between px-5 sm:px-6 py-3 gap-3">
                        <div id="senaraiInfo" class="text-xs sm:text-sm text-gray-600"></div>
                        <div class="flex items-center gap-2">
                            <button id="senaraiPrev" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-600">Sebelum</button>
                            <div id="senaraiPageLabel" class="text-xs sm:text-sm text-gray-600">Halaman 1 daripada 1</div>
                            <button id="senaraiNext" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-600">Seterusnya</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- =============== TAB 3: Analisis Layak Sijil =============== -->
            <!-- Sticky Card (atas, kekal) -->
            <section data-tab-panel="layaksijil" class="ls-sticky-card bg-white/80 backdrop-blur border-b border-gray-100 hidden">
                <div class="ls-container px-4 py-4">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 px-4 sm:px-6 py-5">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-5">
                            <span>üìä</span> Analisis Layak Sijil
                        </h2>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <!-- Dropdown Kelas -->
                            <div class="md:col-span-3">
                                <label for="ls-kelasFilter" class="ls-field-label">Kelas</label>
                                <select id="ls-kelasFilter" class="ls-select mt-1">
                                    <option value="">Pilih Kelas</option>
                                </select>
                            </div>

                            <!-- Butang Jana Analisis -->
                            <div>
                                <button id="btnJanaTab3" class="ls-btn mt-6 md:mt-0" onclick="window.generateEligibilityCards && generateEligibilityCards()" disabled>
                                    Jana Analisis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ‚úÖ Kad Ringkasan (asing, bawah sticky, asalnya hidden) -->
            <section id="kadLayakSection" data-tab-panel="layaksijil" data-reveal class="container-max px-4 pt-4 pb-6 hidden">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">

                    <!-- Kad Layak -->
                    <div class="rounded-2xl border border-green-100 bg-green-50 shadow-sm h-[6.5rem]">
                        <div class="h-full px-6 flex items-center justify-between">
                            <div>
                                <p class="text-green-800/90 text-sm">Layak Sijil</p>
                                <div id="countLayak" class="text-green-800 text-3xl font-extrabold leading-tight">0</div>
                                <p id="percentLayak" class="text-green-700 text-sm font-medium">0%</p>
                            </div>
                            <div class="text-3xl">üéì</div>
                        </div>
                    </div>

                    <!-- Kad Tidak Layak -->
                    <div class="rounded-2xl border border-red-100 bg-red-50 shadow-sm h-[6.5rem]">
                        <div class="h-full px-6 flex items-center justify-between">
                            <div>
                                <p class="text-red-800/90 text-sm">Tidak Layak</p>
                                <div id="countTidakLayak" class="text-red-800 text-3xl font-extrabold leading-tight">0</div>
                                <p id="percentTidak" class="text-red-700 text-sm font-medium">0%</p>
                            </div>
                            <div class="text-3xl">‚ùå</div>
                        </div>
                    </div>

                    <!-- Kad Jumlah -->
                    <div class="rounded-2xl border border-indigo-100 bg-indigo-50 shadow-sm h-[6.5rem]">
                        <div class="h-full px-6 flex items-center justify-between">
                            <div>
                                <p class="text-indigo-800/90 text-sm">Jumlah Murid</p>
                                <div id="countJumlah" class="text-indigo-800 text-3xl font-extrabold leading-tight">0</div>
                            </div>
                            <div class="text-3xl">üë•</div>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Tab 3: üìä Jadual Analisis BM & SEJ (asalnya hidden) -->
            <section id="jadualBmSej" data-tab-panel="layaksijil" data-reveal class="container-max px-4 pb-8 hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                    <div class="px-5 sm:px-6 py-3 flex items-center gap-2">
                        <span class="text-2xl">üìä</span>
                        <h2 class="text-xl font-semibold text-gray-800">Jadual Analisis BM & SEJ</h2>
                    </div>
                    <div class="table-wrapper">
                        <table class="w-full text-[14px] border-collapse min-w-[600px]">
                            <thead>
                                <tr class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                                    <th class="px-3 py-2 text-center">MATA PELAJARAN</th>
                                    <th class="px-3 py-2 text-center">Hadir</th>
                                    <th class="px-3 py-2 text-center">TH</th>
                                    <th class="px-3 py-2 text-center">A+</th>
                                    <th class="px-3 py-2 text-center">A</th>
                                    <th class="px-3 py-2 text-center">A-</th>
                                    <th class="px-3 py-2 text-center">B+</th>
                                    <th class="px-3 py-2 text-center">B</th>
                                    <th class="px-3 py-2 text-center">C+</th>
                                    <th class="px-3 py-2 text-center">C</th>
                                    <th class="px-3 py-2 text-center">D</th>
                                    <th class="px-3 py-2 text-center">E</th>
                                    <th class="px-3 py-2 text-center">G</th>
                                    <th class="px-3 py-2 text-center">%Lulus</th>
                                    <th class="px-3 py-2 text-center">%Gagal</th>
                                    <th class="px-3 py-2 text-center">GPMP</th>
                                </tr>
                            </thead>
                            <tbody id="bmSejBody" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ‚úÖ Kad Analisis Silang BM & SEJ -->
            <section id="kadSilangBmSej" data-tab-panel="layaksijil" data-reveal class="container-max px-4 pt-4 pb-6 hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                    <div class="px-5 sm:px-6 py-3 flex items-center gap-2 border-b">
                        <span class="text-2xl">üîÑ</span>
                        <h2 class="text-xl font-semibold text-gray-800">Analisis Silang BM & SEJ</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse">
                            <thead>
                                <tr class="bg-gradient-to-r from-teal-500 to-cyan-600 text-white">
                                    <th class="px-3 py-2">BM / SEJ</th>
                                    <th class="px-3 py-2">SEJ Lulus</th>
                                    <th class="px-3 py-2">SEJ Gagal</th>
                                    <th class="px-3 py-2">SEJ TH</th>
                                    <th class="px-3 py-2 bg-yellow-500">Jumlah</th>
                                </tr>
                            </thead>
                            <tbody id="silangBmSejBody" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ‚úÖ Kad Senarai Murid (Tab 3: Layak Sijil) -->
            <section id="kadSenaraiLayak" data-tab-panel="layaksijil" data-reveal class="container-max px-4 pt-4 pb-10 hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                    <div class="px-5 sm:px-6 py-3 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">üë•</span>
                            <h2 class="text-xl font-semibold text-gray-800">Senarai Murid</h2>
                        </div>
                        <div>
                            <!-- Pilihan bilangan per halaman -->
                            <select id="layakPageSize" class="border rounded-lg px-3 py-2 text-sm">
                                <option value="5" selected>5 per halaman</option>
                                <option value="10">10 per halaman</option>
                                <option value="15">15 per halaman</option>
                                <option value="20">20 per halaman</option>
                                <option value="ALL">Semua</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-wrapper">
                        <table class="w-full text-[14px] border-collapse whitespace-nowrap">
                            <thead>
                                <tr class="bg-gradient-to-r from-pink-500 to-purple-600 text-white">
                                    <th class="px-3 py-2 text-center">Bil</th>
                                    <th class="px-3 py-2 text-center">Nama</th>
                                    <th class="px-3 py-2 text-center">Kelas</th>
                                    <th class="px-3 py-2 text-center">
                                        Markah BM
                                        <span id="layakBmMarkahSortBtn" class="sort-btn inline-flex align-middle ml-1">
                                            <svg class="up" viewBox="0 0 24 24">
                                                <path d="M7 14l5-5 5 5z" />
                                            </svg>
                                            <svg class="down" viewBox="0 0 24 24">
                                                <path d="M7 10l5 5 5-5z" />
                                            </svg>
                                        </span>
                                    </th>
                                    <th class="px-3 py-2 text-center">Gred BM</th>
                                    <th class="px-3 py-2 text-center">
                                        Markah SEJ
                                        <span id="layakSejMarkahSortBtn" class="sort-btn inline-flex align-middle ml-1">
                                            <svg class="up" viewBox="0 0 24 24">
                                                <path d="M7 14l5-5 5 5z" />
                                            </svg>
                                            <svg class="down" viewBox="0 0 24 24">
                                                <path d="M7 10l5 5 5-5z" />
                                            </svg>
                                        </span>
                                    </th>
                                    <th class="px-3 py-2 text-center">Gred SEJ</th>
                                    <th class="px-3 py-2 text-center">
                                        Status
                                        <span id="layakStatusSortBtn" class="sort-btn inline-flex align-middle ml-1">
                                            <svg class="up" viewBox="0 0 24 24">
                                                <path d="M7 14l5-5 5 5z" />
                                            </svg>
                                            <svg class="down" viewBox="0 0 24 24">
                                                <path d="M7 10l5 5 5-5z" />
                                            </svg>
                                        </span>
                                    </th>
                                </tr>
                            </thead>

                            <tbody id="senaraiLayakBody" class="divide-y"></tbody>
                        </table>
                    </div>

                    <div class="flex flex-col sm:flex-row items-center justify-between px-5 sm:px-6 py-3 gap-3">
                        <div id="layakInfo" class="text-xs sm:text-sm text-gray-600"></div>
                        <div class="flex items-center gap-2">
                            <button id="layakPrev" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-600">Sebelum</button>
                            <div id="layakPageLabel" class="text-xs sm:text-sm text-gray-600">Halaman 1 daripada 1</div>
                            <button id="layakNext" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-600">Seterusnya</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- =============== TAB 4: Analisis Combat Zone =============== -->
            <!-- Sticky Card -->
            <section data-tab-panel="combatzone" class="cz-sticky-card bg-white/80 backdrop-blur border-b border-gray-100 hidden">
                <div class="cz-container px-4 py-4">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 px-4 sm:px-6 py-5">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-5">
                            <span>‚ö†Ô∏è</span> Analisis Combat Zone
                        </h2>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="cz-kelasFilter" class="field-label">Kelas</label>
                                <select id="cz-kelasFilter" class="cz-select mt-1">
                                    <option value="">Pilih Kelas</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="cz-subjekFilter" class="field-label">Subjek</label>
                                <select id="cz-subjekFilter" class="cz-select mt-1">
                                    <option value="">Pilih Subjek</option>
                                </select>
                            </div>
                            <div>
                                <button id="btnCombatZone" class="cz-btn mt-6 md:mt-0" onclick="window.generateCombatZone && generateCombatZone()" disabled>
                                    Jana Analisis Combat Zone
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ‚úÖ Kad Ringkasan Combat Zone -->
            <section id="kadCombatZoneSection" data-tab-panel="combatzone" data-reveal class="container-max px-4 pt-4 pb-6 hidden">

                <div id="combatZoneKPIs" class="grid grid-cols-1 md:grid-cols-6 gap-4">

                    <!-- Kualiti 1 -->
                    <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-4 border border-yellow-200">
                        <div class="flex items-center justify-between h-full">
                            <div>
                                <p class="text-yellow-600 text-xs font-medium">üèÜ Kualiti 1</p>
                                <p id="countKualiti1" class="text-lg font-bold text-yellow-800">0</p>
                                <p id="percentKualiti1" class="text-xs text-yellow-600">A+, A, A-</p>
                            </div>
                            <div class="text-yellow-500 text-2xl">üèÜ</div>
                        </div>
                    </div>

                    <!-- Kualiti 2 -->
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 border border-gray-200">
                        <div class="flex items-center justify-between h-full">
                            <div>
                                <p class="text-gray-600 text-xs font-medium">ü•à Kualiti 2</p>
                                <p id="countKualiti2" class="text-lg font-bold text-gray-800">0</p>
                                <p id="percentKualiti2" class="text-xs text-gray-600">B+, B</p>
                            </div>
                            <div class="text-gray-500 text-2xl">ü•à</div>
                        </div>
                    </div>

                    <!-- Pertahanan 1 -->
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                        <div class="flex items-center justify-between h-full">
                            <div>
                                <p class="text-blue-600 text-xs font-medium">üõ°Ô∏è Pertahanan 1</p>
                                <p id="countPertahanan1" class="text-lg font-bold text-blue-800">0</p>
                                <p id="percentPertahanan1" class="text-xs text-blue-600">C+, C</p>
                            </div>
                            <div class="text-blue-500 text-2xl">üõ°Ô∏è</div>
                        </div>
                    </div>

                    <!-- Pertahanan 2 -->
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
                        <div class="flex items-center justify-between h-full">
                            <div>
                                <p class="text-orange-600 text-xs font-medium">‚ö†Ô∏è Pertahanan 2</p>
                                <p id="countPertahanan2" class="text-lg font-bold text-orange-800">0</p>
                                <p id="percentPertahanan2" class="text-xs text-orange-600">D, E</p>
                            </div>
                            <div class="text-orange-500 text-2xl">‚ö†Ô∏è</div>
                        </div>
                    </div>

                    <!-- Kuantiti -->
                    <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-lg p-4 border border-red-200">
                        <div class="flex items-center justify-between h-full">
                            <div>
                                <p class="text-red-600 text-xs font-medium">üìä Kuantiti</p>
                                <p id="countKuantiti" class="text-lg font-bold text-red-800">0</p>
                                <p id="percentKuantiti" class="text-xs text-red-600">G, TH</p>
                            </div>
                            <div class="text-red-500 text-2xl">üìä</div>
                        </div>
                    </div>

                    <!-- Jumlah Murid -->
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                        <div class="flex items-center justify-between h-full">
                            <div>
                                <p class="text-purple-600 text-xs font-medium">üë• Jumlah Murid</p>
                                <p id="countJumlahCZ" class="text-lg font-bold text-purple-800">0</p>
                                <p class="text-xs text-purple-600">100%</p>
                            </div>
                            <div class="text-purple-500 text-2xl">üë•</div>
                        </div>
                    </div>

                </div>
            </section>

            </section>

            <!-- ‚úÖ Jadual Pecahan Combat Zone Mengikut Kelas TAB 4 -->
            <section id="combatZoneClassBreakdownSection" data-tab-panel="combatzone" class="container-max px-4 pb-6 hidden">

                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">
                        üìä Jadual Pecahan Mengikut Kelas
                    </h3>
                    <div class="table-wrapper">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="text-white text-sm">
                                    <th class="px-3 py-1 text-left font-medium bg-red-600">Kelas</th>
                                    <th class="px-3 py-1 text-center font-medium bg-purple-400 text-gray-800">Jumlah</th>
                                    <th class="px-3 py-1 text-center font-medium bg-yellow-400 text-gray-800">üèÜ Kualiti 1</th>
                                    <th class="px-3 py-1 text-center font-medium bg-gray-300 text-gray-800">ü•à Kualiti 2</th>
                                    <th class="px-3 py-1 text-center font-medium bg-blue-400 text-gray-800">üõ°Ô∏è Pertahanan 1</th>
                                    <th class="px-3 py-1 text-center font-medium bg-orange-300 text-gray-800">‚ö†Ô∏è Pertahanan 2</th>
                                    <th class="px-3 py-1 text-center font-medium bg-red-300 text-gray-800">üìä Kuantiti</th>
                                </tr>
                            </thead>
                            <tbody id="combatZoneClassBreakdownTable" class="divide-y divide-gray-200 text-sm">
                                <!-- baris dinamik dari JS -->
                            </tbody>

                        </table>
                    </div>
                </div>

            </section>

            <!-- TAB 4 Senarai Murid Mengikut Kategori -->
            <section id="combatZoneCategorySection" data-tab-panel="combatzone" class="container-max px-4 pb-6 hidden">

                <div class="bg-white rounded-lg shadow-sm p-6">

                    <!-- Tajuk + ikon cetak kecil (Gaya A) -->
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">
                            üë• Senarai Murid Mengikut Kategori
                        </h3>

                        <!-- Ikon cetak SVG -->
                        <button onclick="cetakCombatZone()" title="Cetak Jadual" class="text-gray-500 hover:text-indigo-600 transition-transform hover:scale-110">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 9V2h12v7m-3 4h3a2 2 0 012 2v5h-4v-3H8v3H4v-5a2 2 0 012-2h3m0 0V9h6v4H9z" />
                            </svg>
                        </button>
                    </div>

                    <!-- Butang Tab Kategori -->
                    <div class="flex gap-2 mb-4 flex-wrap">
                        <button id="combatZoneTab-kualiti1" class="px-3 py-1 rounded bg-gray-200 text-gray-700 kategori-btn" onclick="switchCombatZoneCategory('kualiti1')">
                            üèÜ Kualiti 1 (<span id="kualiti1TabCount">0</span>)
                        </button>
                        <button id="combatZoneTab-kualiti2" class="px-3 py-1 rounded bg-gray-200 text-gray-700 kategori-btn" onclick="switchCombatZoneCategory('kualiti2')">
                            ü•à Kualiti 2 (<span id="kualiti2TabCount">0</span>)
                        </button>
                        <button id="combatZoneTab-pertahanan1" class="px-3 py-1 rounded bg-gray-200 text-gray-700 kategori-btn" onclick="switchCombatZoneCategory('pertahanan1')">
                            üõ°Ô∏è Pertahanan 1 (<span id="pertahanan1TabCount">0</span>)
                        </button>
                        <button id="combatZoneTab-pertahanan2" class="px-3 py-1 rounded bg-gray-200 text-gray-700 kategori-btn" onclick="switchCombatZoneCategory('pertahanan2')">
                            ‚ö†Ô∏è Pertahanan 2 (<span id="pertahanan2TabCount">0</span>)
                        </button>
                        <button id="combatZoneTab-kuantiti" class="px-3 py-1 rounded bg-gray-200 text-gray-700 kategori-btn" onclick="switchCombatZoneCategory('kuantiti')">
                            üìä Kuantiti (<span id="kuantitiTabCount">0</span>)
                        </button>
                    </div>

                    <!-- Jadual Senarai Murid -->
                    <div class="table-wrapper">
                        <table id="combatZoneTable" class="w-full border-collapse text-sm">
                            <thead id="combatZoneCategoryHeader">
                                <tr class="bg-gradient-to-r from-purple-500 to-pink-500 text-white">
                                    <th class="px-4 py-2 text-left">Bil</th>
                                    <th class="px-4 py-2 text-left">Nama</th>
                                    <th class="px-4 py-2 text-center">Kelas</th>
                                    <th class="px-4 py-2 text-center">GP Murid</th>
                                </tr>
                            </thead>
                            <tbody id="combatZoneCategoryStudentTable">
                                <tr>
                                    <td colspan="4" class="p-4 text-gray-400 text-center">
                                        Tiada data
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            <!-- ====== GAYA KHAS Combat Zone ====== -->
            <style>
                /* --- Gaya umum untuk header dengan butang sort --- */
                th .sort-btn {
                    display: inline-flex;
                    /* ‚¨ÖÔ∏è sejajar sebelah teks */
                    flex-direction: column;
                    /* masih kekalkan ‚ñ≤ di atas ‚ñº */
                    align-items: center;
                    /* tengah-tengah menegak */
                    justify-content: center;
                    margin-left: 4px;
                    /* jarak dari teks */
                    vertical-align: middle;
                    /* sejajar dengan teks */
                }

                th .sort-btn svg {
                    width: 8px;
                    height: 8px;
                    fill: #1e40af;
                    /* warna ikon biru */
                    display: block;
                    line-height: 1;
                    margin: -2px 0;
                    /* rapatkan jarak antara ikon */
                }

                .cz-field-label {
                    font-size: .65rem;
                    color: #374151;
                    font-weight: 600
                }

                .cz-select {
                    width: 100%;
                    border: 1px solid #e5e7eb;
                    border-radius: 0.55rem;
                    padding: 0.75rem 1rem;
                    font-size: .95rem;
                    background: #fff;
                    box-shadow: 0 1px 2px rgba(16, 24, 40, .04);
                }

                .cz-select:focus {
                    border-color: #ef4444;
                    box-shadow: 0 0 0 3px rgba(239, 68, 68, .25)
                }

                .cz-btn {
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    width: 100%;
                    padding: .875rem 1rem;
                    border-radius: .9rem;
                    font-weight: 700;
                    color: #fff;
                    background: #dc2626;
                    /* merah */
                    box-shadow: 0 1px 3px rgba(220, 38, 38, .25);
                    transition: transform .06s, filter .15s, background .15s;
                }

                .cz-btn:hover {
                    filter: brightness(1.05)
                }

                .cz-btn:active {
                    transform: scale(.985)
                }

                .cz-container {
                    max-width: 1200px;
                    margin-left: auto;
                    margin-right: auto
                }

                /* ‚úÖ Tambahan khas untuk kad Combat Zone */
                #kadCombatZoneSection .rounded-2xl {
                    height: 4.5rem !important;
                    /* asal 6.5rem ‚Üí jadi lebih nipis */
                }

                #kadCombatZoneSection p.text-sm {
                    font-size: 0.8rem !important;
                    /* kecilkan tajuk */
                    font-weight: 600;
                    /* kekalkan tebal supaya jelas */
                }

                .sort-btn {
                    display: inline-flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    margin-left: 4px;
                    cursor: pointer;
                }

                .sort-btn svg {
                    width: 12px;
                    height: 12px;
                    fill: #9ca3af;
                }

                .sort-btn.asc .up {
                    fill: #2563eb;
                }

                .sort-btn.desc .down {
                    fill: #2563eb;
                }
            </style>

            <!-- ====== GAYA KHAS (namespaced `ls-`) ====== -->
            <style>
                /* Asas supaya komponen ini tidak bertembung gaya lain */
                .ls-field-label {
                    font-size: .95rem;
                    color: #374151;
                    font-weight: 600
                }

                .ls-select {
                    width: 100%;
                    border: 1px solid #e5e7eb;
                    border-radius: 0.75rem;
                    padding: 0.75rem 1rem;
                    font-size: .95rem;
                    background: #fff;
                    box-shadow: 0 1px 2px rgba(16, 24, 40, .04);
                    outline: none;
                    transition: border-color .15s, box-shadow .15s;
                }

                .ls-select:focus {
                    border-color: #3b82f6;
                    box-shadow: 0 0 0 3px rgba(59, 130, 246, .25)
                }

                .ls-btn {
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    width: 100%;
                    padding: .875rem 1rem;
                    border-radius: .9rem;
                    font-weight: 700;
                    color: #fff;
                    background: #3b5bfd;
                    box-shadow: 0 1px 3px rgba(59, 91, 253, .25);
                    transition: transform .06s, filter .15s, background .15s;
                }

                .ls-btn:hover {
                    filter: brightness(1.05)
                }

                .ls-btn:active {
                    transform: scale(.985)
                }

                .ls-container {
                    max-width: 1200px;
                    margin-left: auto;
                    margin-right: auto
                }
            </style>

            <!-- üéØ Section 1: Pilihan kelas & murid (Sticky) -->
            <!-- =================== TAB 5: ANALISIS INDIVIDU CETAKAN SIJIL =================== -->
            <section data-tab-panel="individu" class="hidden"> <!-- üéØ Sticky bar: Pilihan kelas & murid -->
                <div class="cz-sticky-card bg-white/80 backdrop-blur border-b border-gray-100">
                    <div class="container-max px-4 py-4">
                        <div class="bg-white rounded-2xl border border-gray-100 px-4 sm:px-6 py-5">
                            <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-5"> <span>üë§</span> Cetak Slip Individu </h2>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div> <label for="kelasFilterIndividu" class="field-label">Kelas</label> <select id="kelasFilterIndividu" class="select-like mt-1" onchange="updateMuridDropdownIndividu()">
                                        <option value="">Pilih Kelas</option>
                                    </select> </div>
                                <div class="md:col-span-2"> <label for="muridFilterIndividu" class="field-label">Nama Murid</label> <select id="muridFilterIndividu" class="select-like mt-1">
                                        <option value="">Pilih Nama Murid</option>
                                    </select> </div>
                                <div> <button class="btn-primary btn-green mt-6 md:mt-0" onclick="janaSlipIndividu()"> Cetak Slip Individu </button> </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- ‚úÖ Slip hanya dalam tab individu -->
                <div id="slipIndividuSection" class="container-max px-4 py-4 hidden">
                    <div class="slip-wrapper">
                        <div class="slip-container"> <!-- Header -->
                            <div class="slip-header"> <img src="https://leepie.github.io/kbs/KBs-LOGO-FINAL.png" alt="Logo">
                                <p><b>SEKOLAH MENENGAH KAMPUNG BAHAGIA<br> TELUK INTAN, PERAK DR</b></p>
                                <p class="slip-title">SLIP KEPUTUSAN PEPERIKSAAN UASA (TOV T4) SESI AKADEMIK TAHUN 2025</p>
                            </div> <!-- Maklumat Murid -->
                            <table>
                                <tr>
                                    <td colspan="3"><b>NAMA :</b> <span id="namaMurid"></span></td>
                                </tr>
                                <tr>
                                    <td><b>KELAS :</b> <span id="kelasMurid"></span></td>
                                    <td colspan="2"><b>NO K/P :</b> <span id="icMurid"></span></td>
                                </tr>
                            </table> <!-- Jadual Subjek -->
                            <table style="margin-top:10px;">
                                <tr>
                                    <th style="width:30px">BIL</th>
                                    <th style="width:300px">MATA PELAJARAN</th>
                                    <th style="width:100px">MARKAH</th>
                                    <th style="width:100px">GRED</th>
                                    <th style="width:300px">ULASAN GURU</th>
                                </tr>
                                <tbody id="subjectBody"></tbody>
                            </table> <!-- Ringkasan -->
                            <table style="margin-top:15px;">
                                <tr>
                                    <td class="grey">JUMLAH MARKAH :</td>
                                    <td class="center" id="jumlahMarkah"></td>
                                </tr>
                                <tr>
                                    <td class="grey">PERATUS :</td>
                                    <td class="center" id="peratus"></td>
                                </tr>
                                <tr>
                                    <td class="grey">GRED PURATA :</td>
                                    <td class="center" id="gpk"></td>
                                </tr>
                                <tr>
                                    <td class="grey">KEDUDUKAN DALAM KELAS :</td>
                                    <td class="center" id="kedudukanKelas"></td>
                                </tr>
                                <tr>
                                    <td class="grey">KEDUDUKAN DALAM TINGKATAN :</td>
                                    <td class="center" id="kedudukanTingkatan"></td>
                                </tr>
                                <tr>
                                    <td class="grey">KEHADIRAN :</td>
                                    <td class="center" id="kehadiran"></td>
                                </tr>
                                <tr>
                                    <td class="grey">PENCAPAIAN GRED KESELURUHAN :</td>
                                    <td class="center" id="gredKeseluruhan"></td>
                                </tr>
                                <tr>
                                    <td class="grey">KEPUTUSAN :</td>
                                    <td class="center" id="keputusan"></td>
                                </tr>
                            </table>
                            <div class="print-btn" style="text-align:center; margin-top:20px;"> <button onclick="cetakSlipIndividu()">üñ®Ô∏è</button> </div>
                        </div>
                    </div>
                </div>
            </section>

            <style>
                /* ============================== üéØ KHAS UNTUK CETAK SLIP ============================== */
                /* üéØ Tambahan: Benarkan skrol mendatar untuk lihat slip seterusnya */
                #slipIndividuSection {
                    overflow-x: auto;
                    /* Boleh skrol kiri-kanan */
                    white-space: nowrap;
                    /* Susunan slip dalam satu baris */
                    scroll-snap-type: x mandatory;
                    /* Snap effect semasa skrol */
                }

                #slipIndividuSection .slip-wrapper {
                    display: inline-block;
                    /* Letak slip sebelah-menyebelah */
                    vertical-align: top;
                    margin-right: 20px;
                    /* Jarak antara slip */
                    scroll-snap-align: start;
                }

                /* ============================ üéØ GAYA SKRIN (Paparan Web) ============================ */
                 /* üß≠ Centerkan slip dalam paparan */
                /* üö´ Sembunyikan slip individu semasa mula */
               /* üö´ Sembunyi slip semasa mula */
               #slipIndividuSection.hidden {
                   display: none !important;
               }
            
              /* üéØ Bila muncul, kekalkan posisi tengah */
               #slipIndividuSection {
                   display: flex;
                   justify-content: center;
                   align-items: flex-start;
                   overflow-x: auto;
                   padding-bottom: 20px;
                }
            
                #slipIndividuSection .slip-wrapper {
                    flex: 0 0 auto;           /* Kekalkan lebar asal slip */
                }
                #slipIndividuSection .slip-container {
                    width: 1000px;
                    margin: 20px auto;
                    border: 1px solid #ddd;
                    border-radius: 12px;
                    padding: 20px;
                    background: #fff;
                    font-family: Arial, sans-serif;
                    font-size: 12pt;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
                }

                #slipIndividuSection .slip-header {
                    text-align: center;
                }

                #slipIndividuSection .slip-header img {
                    height: 100px;
                    display: block;
                    margin: 0 auto;
                }

                #slipIndividuSection .slip-title {
                    font-weight: bold;
                    text-decoration: underline;
                    margin: 10px 0;
                }

                #slipIndividuSection table {
                    border-collapse: collapse;
                    width: 100%;
                    table-layout: fixed;
                }

                #slipIndividuSection td,
                #slipIndividuSection th {
                    border: 1px solid black;
                    padding: 4px;
                    vertical-align: middle;
                }

                #slipIndividuSection th {
                    background: #d9d9d9;
                }

                #slipIndividuSection .grey {
                    background: #d9d9d9;
                    font-weight: bold;
                    text-align: left;
                }

                #slipIndividuSection .center {
                    text-align: center;
                }

                #slipIndividuSection .ulasan-container {
                    display: flex;
                    flex-direction: column;
                    justify-content: flex-end;
                    height: 100%;
                }

                #slipIndividuSection .ulasan-space {
                    flex: 1;
                }

                #slipIndividuSection .label-row {
                    text-align: center;
                    font-weight: bold;
                    background: #d9d9d9;
                    padding: 2px;
                    font-size: 11pt;
                    border-top: 1px solid black;
                }

                #slipIndividuSection .sign-space {
                    height: 85px;
                    border-bottom: 1px solid #000;
                    margin-bottom: 6px;
                }

                #slipIndividuSection .subject-row td {
                    height: 28px;
                }

                .btn-green {
                    background-color: #16a34a !important;
                    color: #fff !important;
                }

                .btn-green:hover {
                    background-color: #15803d !important;
                    color: #fff !important;
                }
            </style>

            <style id="print-slip-individu-global-reset">
                /* üß≠ CETAK SLIP INDIVIDU (vStabil)
           - Tiada CSS @media print global di halaman utama.
           - Semua gaya cetak akan disuntik dalam popup khas (fungsi cetakSlipIndividu).
           - Elak gangguan terhadap tab lain seperti Combat Zone & Rumusan Subjek. */
            </style>

            <script>
                function cetakSlipIndividu() {
                    const slipSection = document.getElementById("slipIndividuSection");
                    if (!slipSection) return alert("Slip tidak ditemui!");

                    const slipHTML = slipSection.innerHTML;
                    const w = window.open("", "_blank", "width=1000,height=800");
                    w.document.open();
                    w.document.write(`
        <!DOCTYPE html>
        <html lang="ms">
        <head>
        <meta charset="utf-8" />
        <title>Cetak Slip Individu</title>
        <style>
          @page { size: A4 portrait; margin: 10mm; }
        
          html, body {
            background: #fff;
            font-family: Arial, sans-serif;
            font-size: 11pt;
            margin: 0;
            padding: 0;
            zoom: 0.97; /* ‚úÖ Kunci skala supaya tak potong kanan */
          }
        
          .slip-container {
            width: 100%;
            max-width: 187mm; /* ‚úÖ dalam safe zone cetak */
            margin: 0 auto;
            border: 1px solid #000;
            padding: 12px;
            box-sizing: border-box;
          }
        
          table {
            width: 100%;
            border-collapse: collapse;
            /* ‚úÖ guna auto layout masa cetak */
            table-layout: auto;
          }
        
          td, th {
            border: 1px solid #000;
            padding: 4px;
            vertical-align: middle;
            box-sizing: border-box;
          }
        
          th { background: #d9d9d9; }
          .grey { background: #d9d9d9; font-weight: bold; text-align: left; }
          .center { text-align: center; }
        
          /* ‚úçÔ∏è Ruang ulasan & tandatangan */
          .ulasan-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            height: 100%;
          }
          .ulasan-space { flex: 1; padding: 10px; white-space: pre-line; }
          .label-row {
            text-align: center;
            font-weight: bold;
            background: #d9d9d9;
            padding: 2px;
            font-size: 11pt;
            border-top: 1px solid #000;
          }
          .sign-space {
            height: 85px;
            border-bottom: 1px solid #000;
            margin-bottom: 6px;
          }
        
          .subject-row td { height: 28px; }
        
          /* üè´ Header sekolah */
          .slip-header { text-align:center; margin-bottom:10px; }
          .slip-header img { height:80px; display:block; margin:0 auto; }
        
          /* ‚ùå Sembunyi butang interaktif */
          button, .print-btn { display:none !important; }
        
          @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          }
        </style>
        </head>
        <body>
        ${slipHTML}
        </body>
        </html>`);
                    w.document.close();

                    w.onload = () => {
                        w.focus();
                        setTimeout(() => {
                            w.print();
                            w.onafterprint = () => w.close();
                        }, 400);
                    };
                }
            </script>

            <script>
                // ‚úÖ Isi dropdown kelas bila CSV sudah dimuat
                function autoIsiDropdownKelasIndividu(data) {
                    const kelasHeader = cariKolum("kelas");
                    const kelasSet = new Set(data.map(r => (r[kelasHeader] || "").trim()).filter(k => k && k !== "1"));
                    const sel = document.getElementById("kelasFilterIndividu");
                    sel.innerHTML = "<option value=''>Pilih Kelas</option>";
                    [...kelasSet].sort().forEach(k => {
                        const o = document.createElement("option");
                        o.value = k;
                        o.textContent = k;
                        sel.appendChild(o);
                    });
                }

                // ‚úÖ Bila kelas ditukar ‚Üí update nama murid
                function updateMuridDropdownIndividu() {
                    const kelasDipilih = document.getElementById("kelasFilterIndividu").value;
                    const muridSel = document.getElementById("muridFilterIndividu");
                    muridSel.innerHTML = "<option value=''>Pilih Nama Murid</option>";
                    if (!kelasDipilih) return;

                    const kelasHeader = cariKolum("kelas");
                    const namaHeader = cariKolum("nama");

                    cachedData
                        .filter(r => (r[kelasHeader] || "").trim() === kelasDipilih)
                        .filter(r => (r[namaHeader] || "").trim() && !/^\d+$/.test(r[namaHeader])) // buang nama pelik
                        .forEach(r => {
                            const o = document.createElement("option");
                            o.value = r[namaHeader];
                            o.textContent = r[namaHeader];
                            muridSel.appendChild(o);
                        });
                }

                // ‚úÖ Jana slip bila klik butang
                function janaSlipIndividu() {
                  const murid = document.getElementById("muridFilterIndividu").value;
                  const slipSection = document.getElementById("slipIndividuSection");
                
                  // üö´ Sembunyikan slip setiap kali sebelum jana semula
                  slipSection.classList.add("hidden");
                
                  if (!murid) {
                    alert("Sila Pilih Kelas & Nama Murid!");
                    return;
                  }
                
                  // ‚öôÔ∏è Jana slip murid seperti biasa
                  paparSlipIndividu(murid);
                
                  // ‚úÖ Paparkan semula selepas sedikit masa (bagi nampak smooth)
                  setTimeout(() => {
                    slipSection.classList.remove("hidden");
                    slipSection.style.display = "flex";   // pastikan muncul di tengah (kalau guna gaya center)
                  }, 300);
                }


                // ‚úÖ Papar slip individu direct dari CSV (ikut header sebenar)
                function paparSlipIndividu(namaMurid) {
                    const namaHeader = cariKolum("nama");
                    const kelasHeader = cariKolum("kelas");
                    const icHeader = cariKolum("no k/p");

                    // Ringkasan dari CSV
                    const jumlahHdr = cariKolum("jumlah markah");
                    const peratusHdr = cariKolum("%");
                    const gpkHdr = cariKolum("gred purata");
                    const kedKelasHdr = cariKolum("kedudukan dalam kelas");
                    const kedTktnHdr = cariKolum("kedudukan dalam tingkatan");
                    const hadirHdr = cariKolum("kehadiran");
                    const gredKesHdr = cariKolum("gred keseluruhan");
                    const keputusanHdr = cariKolum("keputusan");
                    const ulasanHdr = cariKolum("ulasan");

                    const row = cachedData.find(r => (r[namaHeader] || "").toUpperCase() === namaMurid.toUpperCase());
                    if (!row) {
                        alert("Murid tidak ditemui!");
                        return;
                    }

                    // Isi maklumat asas
                    document.getElementById("namaMurid").innerText = row[namaHeader];
                    document.getElementById("kelasMurid").innerText = row[kelasHeader];
                    document.getElementById("icMurid").innerText = row[icHeader] || "-";

                    // Reset jadual subjek
                    const tbody = document.getElementById("subjectBody");
                    tbody.innerHTML = "";

                    let bil = 1; // kira bilangan subjek sebenar
                    const ulasan = row[ulasanHdr] || "";

                    // Loop semua subjek dari CSV
                    subjectColumns.forEach(col => {
                        const subjekCode = col.split(" ")[0];
                        const colMark = cariKolumMarkahSubjek(subjekCode);
                        const colGred = cariKolumGredSubjek(subjekCode);
                        const markah = colMark ? row[colMark] : "";
                        const gred = colGred ? (row[colGred] || "").toUpperCase() : "";

                        if (markah !== "" || gred !== "") {
                            tbody.innerHTML += `
        <tr class="subject-row">
          <td class="center">${bil++}</td>
          <td>${subjectNameMap[subjekCode] || subjekCode}</td>
          <td class="center">${markah}</td>
          <td class="center">${gred}</td>
          ${bil===2 ? `<td rowspan="20" style="padding:0; vertical-align:top;">
            <div class="ulasan-container" style="display:flex; flex-direction:column; height:100%;">
              <div class="ulasan-space" style="flex:1; padding:10px; white-space:pre-line;">
                ${ulasan}
              </div>
              <div class="label-row">T. TANGAN GURU KELAS</div><div class="sign-space"></div>
              <div class="label-row">T. TANGAN PENGETUA</div><div class="sign-space"></div>
              <div class="label-row">T. TANGAN IBU/BAPA/PENJAGA</div><div class="sign-space"></div>
            </div>
          </td>` : ""}
        </tr>`;
                        }
                    });

                    // Tambah baki baris kosong hingga 20 (tanpa nombor)
                    const currentRows = tbody.querySelectorAll("tr").length;
                    for (let i = currentRows + 1; i <= 20; i++) {
                        tbody.innerHTML += `
        <tr class="subject-row">
          <td class="center"></td>
          <td></td><td></td><td></td>
        </tr>`;
                    }

                    // ‚úÖ Isi ringkasan direct dari CSV
                    document.getElementById("jumlahMarkah").innerText = row[jumlahHdr] || "-";
                    document.getElementById("peratus").innerText = row[peratusHdr] || "-";
                    document.getElementById("gpk").innerText = row[gpkHdr] || "-";
                    document.getElementById("kedudukanKelas").innerText = row[kedKelasHdr] || "-";
                    document.getElementById("kedudukanTingkatan").innerText = row[kedTktnHdr] || "-";

                    const hadir = row[hadirHdr];
                    document.getElementById("kehadiran").innerText = hadir && hadir.toString().trim() !== "" ? hadir : "-";

                    document.getElementById("gredKeseluruhan").innerText = row[gredKesHdr] || "-";
                    document.getElementById("keputusan").innerText = row[keputusanHdr] || "-";
                }
            </script>

            <!-- =============== Tamat Kad Sticky Tab Analisis Layak Sijil =============== -->
            <!-- =================== FOOTER =================== -->
            <footer class="mt-10">
                <div class="h-0.5 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 opacity-70"></div>
                <div class="text-center text-[11px] sm:text-xs text-gray-500 py-3">
                    ¬© 2025 <span class="font-medium">XCode Mr LePaK</span> - Analisis PPSA vs PraSPM
                </div>
            </footer>

            <script>
                /* ===========================================================
       üìå INDEX FUNGSI ANALISIS
       ===========================================================
       üîπ TAB 1 ‚Äì Analisis Keseluruhan
          - generateOverallAnalysis()
          - updateGradeChartBySubject(dataTapis)
          - updateSubjectAnalysis(dataTapis)
          - renderSubjectTable()
    
       üîπ TAB 2 ‚Äì Analisis Mata Pelajaran
          - generateSubjectCards()
          - renderPecahanKelasTable(data, subjekCode)
          - drawPecahanKelasBody()
          - renderSenaraiMuridTable(data, subjekCode)
          - getSortedSenaraiRows()
          - drawSenaraiMuridPage()
    
       üîπ TAB 3 ‚Äì Analisis Layak Sijil
          - generateEligibilityCards()
          - renderSenaraiMuridLayak(data)
          - renderSilangBmSej(data)
          - renderBmSejTable(data)
          - getSortedLayakRows()
          - drawLayakPage()
          - resetLayakSort(except)
    
       üîπ TAB 4 ‚Äì Analisis Combat Zone
          - generateCombatZone()
          - switchCombatZoneCategory(kat)
          - updateCard(idCount, idPercent, val)
          - renderCombatZoneClassBreakdown(data, subjekTerpilih, kelasTerpilih)
       =========================================================== */
// const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQdnpPQ7vfOqMuuV-DzAmPtQjCEZBwVtXxLBpGFUguqC3ZqqouMN_Bey3AIzXSPBlziV1bNKSpGjfBY/pub?gid=1172655606&single=true&output=csv";
                /* ========= CSV & UTIL ========= */
               /* PPSA TOV T4*/
            //    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQdnpPQ7vfOqMuuV-DzAmPtQjCEZBwVtXxLBpGFUguqC3ZqqouMN_Bey3AIzXSPBlziV1bNKSpGjfBY/pub?gid=1172655606&single=true&output=csv";
                  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWkpC9SvzPcCxmdtffbxaEbpD5cKmtZ86cN72b6ISdgXCNUzgeKwDVoVfYWhZ5lp5CBWZAimPjgLiV/pub?gid=22937657&single=true&output=csv";
               
                const gradeValueMapping = {
                    "A+": 0,
                    "A": 1,
                    "A-": 2,
                    "B+": 3,
                    "B": 4,
                    "C+": 5,
                    "C": 6,
                    "D": 7,
                    "E": 8,
                    "G": 9
                };
                const chartGradeLabels = ["A+", "A", "A-", "B+", "B", "C+", "C", "D", "E", "G"];
                const topGradeLabels = ["A+", "A", "A-", "B+", "B", "C+", "C"];
                const gradeColors = {
                    "A+": "#16a34a",
                    "A": "#22c55e",
                    "A-": "#86efac",
                    "B+": "#eab308",
                    "B": "#facc15",
                    "C+": "#fb923c",
                    "C": "#f97316",
                    "D": "#f87171",
                    "E": "#ef4444",
                    "G": "#991b1b"
                };

                const subjectNameMap = {
                    "BM": "BAHASA MELAYU",
                    "BI": "BAHASA INGGERIS",
                    "M": "MATEMATIK",
                    "SN": "SAINS",
                    "MT": "MATEMATIK TAMBAHAN",
                    "SEJ": "SEJARAH",
                    "PAI": "PENDIDIKAN ISLAM",
                    "PM": "PENDIDIKAN MORAL",
                    "PSV": "PENDIDIKAN SENI VISUAL",
                    "PJK": "PENDIDIKAN JASMANI DAN KESIHATAN",
                    "BIO": "BIOLOGI",
                    "KIM": "KIMIA",
                    "FIZ": "FIZIK",
                    "SS": "SAINS SUKAN",
                    "SK": "SAINS KOMPUTER",
                    "SRT": "SAINS RUMAH TANGGA",
                    "PER": "PERTANIAN",
                    "PP": "PERNIAGAAN",
                    "PA": "PRINSIP PERAKAUNAN",
                    "TAS": "TASAWWUR ISLAM",
                    "PAIM": "PENDIDIKAN ISLAM MPAK",
                    "GEO": "GEOGRAFI",
                    "BT": "BAHASA TAMIL",
                    "KT": "KESUSASTERAAN TAMIL",
                    "RC": "REKA CIPTA",
                    "SPER": "SAINS PERTANIAN"
                };
                const subjectGroupMap = {
                    "Bahasa": ["BM", "BI", "BT", "KT"],
                    "Kemanusiaan": ["PAI", "PM", "SEJ", "GEO", "PSV", "PJK", "PAIM", "TAS"],
                    "Sains & Matematik": ["M", "SN", "MT", "FIZ", "BIO", "KIM"],
                    "Teknik & Vokasional": ["SK", "SRT", "PER", "PP", "PA", "SS", "RC", "SPER"]
                };
              
                let headerMap = {},
                    subjectColumns = [],
                    cachedData = null,
                    gradeChartInstance = null,
                    subjectFlagMap = {};

                // GPMP sort (subjek)
                let subjectStatsCurrent = [],
                    subjectStatsOriginal = [],
                    gpmpSortState = "none";
                // GPMP sort (pecahan kelas)
                let pecahanKelasRowsOriginal = [],
                    pecahanKelasRowsCurrent = [],
                    gpmpKelasSortState = "none";

                // Senarai Murid (state)
                const senaraiState = {
                    rows: [],
                    rowsOriginal: [],
                    page: 1,
                    pageSize: 5
                }; //ubah
                let markahSortState = "none"; // asc | desc | none
                let gredSortState = "none"; // asc | desc | none

                // Simpanan sementara senarai murid untuk Combat Zone
                let muridDataCZ = [];

                // ‚úÖ Cari kolum umum (padanan penuh, bukan includes)
                function cariKolum(keyword) {
                    const normalise = s => (s || "")
                        .toLowerCase()
                        .replace(/\s+/g, " ") // tukar spasi berganda jadi 1
                        .trim();

                    const k = normalise(keyword);
                    return Object.values(headerMap).find(h => normalise(h) === k);
                }

                // ‚úÖ Cari kolum gred subjek
                function cariKolumGredSubjek(kod) {
                    const upper = kod.toUpperCase();
                    return Object.values(headerMap).find(h => {
                        const H = (h || "").toUpperCase().trim();
                        return H.startsWith(upper + " ") && /\b(G|GRED|GRADE)\b/.test(H);
                    });
                }

                // ‚úÖ Cari kolum markah subjek
                function cariKolumMarkahSubjek(kod) {
                    const upper = kod.toUpperCase();
                    return Object.values(headerMap).find(h => {
                        const H = (h || "").toUpperCase().trim();
                        return H.startsWith(upper + " ") && /\b(M|MARK|MARKAH|MARKS)\b/.test(H);
                    });
                }

//Update fungsi GPS ikut Subjek Utama
                function parseCSV(csv) {
                    // Buang baris kosong
                    let lines = csv
                        .split(/\r?\n/)
                        .map(l => l.trim())
                        .filter(l => l !== "");
                
                    console.log("üëâ BILANGAN BARIS CSV (selepas trim):", lines.length);
                    console.log("üëâ LINE[0]:", lines[0]);
                    console.log("üëâ LINE[1]:", lines[1]);
                    console.log("üëâ LINE[2]:", lines[2]);
                
                    if (lines.length < 3) {
                        console.error("‚ùå CSV format tidak mencukupi.");
                        return [];
                    }
                
                    // --- 3 baris utama ---
                    const flagRow   = parseCSVLine(lines[0]); // 0 / 1
                    const subjekRow = parseCSVLine(lines[1]); // BIL, NO KP, BM, , BI, , M, ...
                    const jenisRow  = parseCSVLine(lines[2]); // "", "", "", "", "", "M","G","M","G",...
                
                    // üîπ Bina header penuh (contoh: "BM M", "BM G")
                    let currentSubjek = "";
                    const headers = subjekRow.map((subjek, i) => {
                        if (subjek) currentSubjek = subjek;
                        return jenisRow[i] ? `${currentSubjek} ${jenisRow[i]}`.trim() : currentSubjek;
                    });
                
                    // Simpan ke headerMap (KEKAL macam asal)
                    headerMap = {};
                    headers.forEach(h => {
                        if (h) headerMap[(h || "").toLowerCase()] = h;
                    });
                
                    console.log("‚úÖ HeaderMap CSV yang digunakan sekarang:");
                    console.table(headerMap);
                
                    // üÜï 1. Bina subjectFlagMap ikut KOLUM MARKAH (M)
                    subjectFlagMap = {};
                    subjekRow.forEach((code, i) => {
                        const jenis = (jenisRow[i] || "").toUpperCase(); // "M", "G", atau kosong
                        const flag  = (flagRow[i]   || "").trim();       // "0" / "1" / ""
                
                        // hanya jika ia kolum markah subjek (M) & ada kod subjek
                        if (code && jenis === "M" && (flag === "0" || flag === "1")) {
                            subjectFlagMap[code.toUpperCase()] = flag;   // contoh: subjectFlagMap["PJK"] = "0"
                        }
                    });
                
                    console.log("üìå subjectFlagMap (0=elektif,1=wajib):", subjectFlagMap);
                
                    // 2. Tapis hanya kolum GRED subjek untuk analisis (KEKAL konsep lama)
                    subjectColumns = headers.filter(h => {
                        if (!h) return false;
                        const upper = (h || "").toUpperCase();
                        if (upper.includes("KESELURUHAN") || upper.includes("PURATA") || upper === "GPMP") {
                            return false;
                        }
                        // ambil hanya kolum G (gred)
                        return /\b(G|GRED|GRADE)\b/i.test(upper);
                    });
                
                    console.log("üëâ subjectColumns:", subjectColumns);
                
                    // 3. Parse data murid (baris ke-4 dan seterusnya)
                    const dataRows = lines.slice(3).map(row => {
                        const vals = parseCSVLine(row);
                        const obj = {};
                        headers.forEach((h, i) => {
                            obj[h] = (vals[i] || "").trim();
                        });
                        return obj;
                    });
                
                    console.log("üìå Rekod pertama:", dataRows[0]);
                
                    // Debug khas KEDUDUKAN / ULASAN (optional)
                    const kedTktnHdr = cariKolum("kedudukan dalam tingkatan");
                    const ulasanHdr  = cariKolum("ulasan");
                    if (dataRows[0]) {
                        console.log("‚Üí KEDUDUKAN DALAM TINGKATAN:", dataRows[0][kedTktnHdr]);
                        console.log("‚Üí ULASAN:", dataRows[0][ulasanHdr]);
                    }
                
                    return dataRows;
                }

                // ‚úÖ Parser baris CSV yang sokong tanda petik
                function parseCSVLine(line) {
                    const result = [];
                    let current = "";
                    let insideQuotes = false;

                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];

                        if (char === '"') {
                            insideQuotes = !insideQuotes; // flip state
                        } else if (char === ',' && !insideQuotes) {
                            result.push(current);
                            current = "";
                        } else {
                            current += char;
                        }
                    }
                    result.push(current); // tambah field terakhir
                    return result.map(s => s.trim());
                }

                // Dropdown Kelas (buang '1')
                function autoIsiDropdownKelasKe(data, elId) {
                    const kelasHeader = cariKolum("kelas");
                    if (!kelasHeader) return;
                    const kelasSet = new Set(
                        data.map(r => (r[kelasHeader] || "").trim())
                        .filter(k => k && k.toUpperCase() !== "SEMUA KELAS" && k !== "1")
                    );
                    const sel = document.getElementById(elId);
                    if (!sel) return;
                    sel.innerHTML = "";
                    const optDefault = document.createElement("option");
                    optDefault.value = "";
                    optDefault.textContent = "Pilih Kelas";
                    sel.appendChild(optDefault);
                    const optAll = document.createElement("option");
                    optAll.value = "SEMUA KELAS";
                    optAll.textContent = "SEMUA KELAS";
                    sel.appendChild(optAll);
                    [...kelasSet].sort((a, b) => a.localeCompare(b, 'ms', {
                        numeric: true
                    })).forEach(k => {
                        const o = document.createElement("option");
                        o.value = k;
                        o.textContent = k;
                        sel.appendChild(o);
                    });
                }
                // Dropdown Subjek auto CSV
                function autoIsiDropdownSubjekKe(elId) {
                    const sel = document.getElementById(elId);
                    if (!sel) return;
                    let subjects = [...new Set(subjectColumns.map(c => (c.split(" ")[0] || "").trim()))]
                        .filter(s => s && s.toUpperCase() !== "GRED" && s !== "G");
                    subjects.sort((a, b) => {
                        const A = (subjectNameMap[a] || a);
                        const B = (subjectNameMap[b] || b);
                        return A.localeCompare(B, 'ms', {
                            numeric: true
                        });
                    });
                    sel.innerHTML = '<option value="">Pilih Subjek</option>';
                    subjects.forEach(code => {
                        const label = (subjectNameMap[code] || code).toUpperCase();
                        const opt = document.createElement('option');
                        opt.value = code;
                        opt.textContent = label;
                        sel.appendChild(opt);
                    });
                }

                function filterSubjectsByBidang(subjects) {
                    const bidang = document.getElementById("bidangFilter")?.value || "Semua Bidang";
                    if (!bidang || bidang === "Semua Bidang") return subjects;
                    const allowed = subjectGroupMap[bidang] || [];
                    return subjects.filter(sub => allowed.includes(sub));
                }

                /* ========= INIT ========= */
                
                document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch(csvUrl);
                console.log("üëâ FETCH STATUS:", res.status, res.ok);
        
                const csv = await res.text();
        
                // ‚úÖ Tunjuk 10 baris pertama CSV mentah
                console.log("üëâ CSV RAW PREVIEW:");
                console.log(csv.split(/\r?\n/).slice(0, 10).join("\n"));
        
                cachedData = parseCSV(csv);
        
                console.log("üëâ JUMLAH REKOD LEPAS PARSE:", cachedData.length);
                console.log("üëâ headerMap:", headerMap);
                console.log("üëâ subjectColumns:", subjectColumns);
        
                if (cachedData.length > 0) {
                    console.log("üëâ 5 REKOD PERTAMA:");
                    console.table(cachedData.slice(0, 5));
                } else {
                    console.warn("‚ö†Ô∏è cachedData kosong. Mungkin parseCSV ada masalah.");
                }
        
                // KPI header keseluruhan
                kiraHeaderKPI(cachedData);
        
                // Dropdown
                autoIsiDropdownKelasKe(cachedData, "kelasFilter");
                autoIsiDropdownKelasKe(cachedData, "kelasFilterMP");
                autoIsiDropdownSubjekKe("subjekFilter");
                autoIsiDropdownKelasKe(cachedData, "ls-kelasFilter");
                autoIsiDropdownKelasKe(cachedData, "cz-kelasFilter");
                autoIsiDropdownSubjekKe("cz-subjekFilter");
                autoIsiDropdownKelasIndividu(cachedData);
        
            } catch (e) {
                console.error("‚ùå Ralat semasa fetch/parse CSV:", e);
            }
        
            showTab('keseluruhan');
        });
              
                function kiraHeaderKPI(data) {
  const gpsElHeader   = document.getElementById('gpsValue');
  const sijilElHeader = document.getElementById('layakSijilValue');

  // ===============================
  // Helper standard (SELARAS TAB 3)
  // ===============================
  const isMissing = (v) =>
    v === null ||
    v === undefined ||
    String(v).trim() === "" ||
    String(v).trim() === "-" ||
    String(v).trim() === "‚Äî";

  const norm = (v) => String(v ?? "").trim().toUpperCase();

  // Gred sah mesti wujud dalam gradeValueMapping
  const isValidGrade = (g) =>
    !isMissing(g) && gradeValueMapping.hasOwnProperty(norm(g));

  // Lulus = gred sah & bukan G / TH
  const isPassed = (g) =>
    isValidGrade(g) && norm(g) !== "G" && norm(g) !== "TH";

  // ===============================
  // Pembolehubah GPS & Sijil
  // ===============================
  let jumlahNilai = 0,
      bilGred     = 0,
      jumlahMurid = 0;

  // Layak Sijil (denominator khas)
  let calonSijil = 0,
      layak      = 0;

  const bmCol  = cariKolumGredSubjek("BM");
  const sejCol = cariKolumGredSubjek("SEJ");

  // ===============================
  // Subjek WAJIB sahaja untuk GPS
  // ===============================
  const wajibColumns = subjectColumns.filter(colName => {
    const subjCode = (colName.split(" ")[0] || "").toUpperCase();
    const flag = subjectFlagMap[subjCode];
    return flag !== "0"; // elektif dikecualikan
  });

  // ===============================
  // Proses setiap murid
  // ===============================
  data.forEach(row => {
    let adaGredWajib = false;

    // ----- GPS -----
    wajibColumns.forEach(col => {
      const g = norm(row[col]);
      if (gradeValueMapping.hasOwnProperty(g)) {
        jumlahNilai += gradeValueMapping[g];
        bilGred++;
        adaGredWajib = true;
      }
    });

    if (adaGredWajib) jumlahMurid++;

    // ----- LAYAK SIJIL -----
    const bm  = bmCol  ? row[bmCol]  : "";
    const sej = sejCol ? row[sejCol] : "";

    // ‚ùó Murid BM/SEJ "-" / kosong ‚Üí BUKAN calon sijil
    if (!isValidGrade(bm) || !isValidGrade(sej)) return;

    calonSijil++;

    if (isPassed(bm) && isPassed(sej)) layak++;
  });

  // ===============================
  // Paparan KPI
  // ===============================
  const gps = bilGred
    ? (jumlahNilai / bilGred).toFixed(2)
    : "-";

  const peratusLayak = calonSijil
    ? ((layak / calonSijil) * 100).toFixed(1) + "%"
    : "-";

  gpsElHeader.textContent   = gps;
  sijilElHeader.textContent = peratusLayak;

  // Debug (boleh buang jika mahu)
  console.log("HEADER GPS:", { jumlahNilai, bilGred, jumlahMurid });
  console.log("HEADER SIJIL:", { calonSijil, layak, peratusLayak });
}



                /* ========= TAB NAV ========= */
                function switchTab(which) {
                    const ids = ['keseluruhan', 'matapelajaran', 'layaksijil', 'combatzone', 'individu'];
                    ids.forEach(id => {
                        const el = document.getElementById('tab-' + id);
                        if (!el) return;
                        el.classList.remove('tab-active');
                        el.classList.add('bg-white');
                    });
                    const active = document.getElementById('tab-' + which);
                    if (active) {
                        active.classList.remove('bg-white');
                        active.classList.add('tab-active');
                    }
                    showTab(which);
                }

                function showTab(which) {
                    document.querySelectorAll('[data-tab-panel]').forEach(p => p.classList.add('hidden'));
                    const panels = document.querySelectorAll(`[data-tab-panel="${which}"]`);
                    panels.forEach(p => p.classList.remove('hidden'));

                    if (which === 'keseluruhan') {
                        document.querySelectorAll(`[data-tab-panel="${which}"][data-reveal]`)
                            .forEach(p => p.classList.add('hidden'));
                    }
                    if (which === 'matapelajaran') {
                        document.getElementById('pecahanKelasCard')?.classList.add('hidden');
                        document.getElementById('senaraiMuridCard')?.classList.add('hidden');
                    }
                    if (which === 'layaksijil') {
                        // ‚úÖ Sembunyikan Kad & Jadual dulu
                        document.getElementById('kadLayakSection')?.classList.add('hidden');
                        document.getElementById('jadualBmSej')?.classList.add('hidden');
                        document.getElementById('kadSilangBmSej')?.classList.add('hidden');
                        document.getElementById('kadSenaraiLayak')?.classList.add('hidden'); // ‚úÖ penting
                    }
                    if (which === 'combatzone') {
                        // ‚úÖ Sembunyikan Kad & Jadual dulu
                        document.getElementById('combatZoneClassBreakdownSection')?.classList.add('hidden');
                        document.getElementById('combatZoneCategorySection')?.classList.add('hidden');
                    }

                    if (which === 'individu') {
                        // ‚úÖ Sembunyikan Kad & Jadual dulu
                        document.getElementById('slipIndividuSection')?.classList.add('hidden');
                    }
                }

                /* ========= TAB 1: ========= */

function getWajibColumns() {
    return subjectColumns.filter(colName => {
        const subjCode = (colName.split(" ")[0] || "").toUpperCase();
        const flag = subjectFlagMap[subjCode];
        if (flag === "0") return false;   // elektif
        return true;                      // 1 atau tiada flag ‚Üí kira
    });
}

function kiraGPSDaripadaRows(rows) {
    const bmCol  = cariKolumGredSubjek("BM");
    const sejCol = cariKolumGredSubjek("SEJ");
    const wajibColumns = getWajibColumns();

    let jumlahNilai  = 0;
    let bilGred      = 0;
    let jumlahMurid  = 0;
    let layak        = 0;

    rows.forEach(row => {
        let adaGred = false;

        wajibColumns.forEach(col => {
            const g = (row[col] || "").toUpperCase();
            if (gradeValueMapping.hasOwnProperty(g)) {
                jumlahNilai += gradeValueMapping[g];
                bilGred++;
                adaGred = true;
            }
        });

        if (adaGred) {
            jumlahMurid++;

            const bm  = (bmCol  ? row[bmCol]  : "").toUpperCase();
            const sej = (sejCol ? row[sejCol] : "").toUpperCase();
            if (bm && sej && bm !== "G" && sej !== "G") {
                layak++;
            }
        }
    });

    const gps = bilGred
        ? (jumlahNilai / bilGred).toFixed(2)
        : "-";

    const peratusLayak = jumlahMurid
        ? ((layak / jumlahMurid) * 100).toFixed(1) + "%"
        : "-";

    return { gps, peratusLayak, jumlahMurid, layak };
}

//START ASAL SINI
                
function generateOverallAnalysis() {
    const kelasHeader = cariKolum("kelas"),
          namaHeader  = cariKolum("nama");
    const kelasTerpilih = document.getElementById("kelasFilter").value;

    // üîπ Tapis ikut kelas / semua kelas
    let dataTapis = (!kelasTerpilih || kelasTerpilih === "SEMUA KELAS")
        ? cachedData
        : cachedData.filter(r => r[kelasHeader] === kelasTerpilih);

    // =======================
    // 1. KPI (Gred Purata, Layak Sijil, Jumlah Murid)
    //    ‚Üí guna helper standard yang sama dengan header
    // =======================
    const hasil = kiraGPSDaripadaRows(dataTapis);

    document.getElementById("kpiGPS").textContent   = hasil.gps;
    document.getElementById("kpiLayak").textContent = hasil.peratusLayak;
    document.getElementById("kpiMurid").textContent = hasil.jumlahMurid;

    // =======================
    // 2. Senarai Murid Terbaik (kekal macam asal)
    // =======================
    let muridList = [];

    dataTapis.forEach(row => {
        const nama = row[namaHeader];
        let gredList = [];

        // ambil semua gred (untuk kira GP individu & pecahan A+, A, A- ... )
        subjectColumns.forEach(c => {
            const g = (row[c] || "").toUpperCase();
            if (gradeValueMapping.hasOwnProperty(g)) {
                gredList.push(g);
            }
        });

        if (gredList.length) {
            const gp = (
                gredList.reduce((a, g) => a + gradeValueMapping[g], 0) /
                gredList.length
            ).toFixed(2);

            const counts = topGradeLabels.reduce((acc, g) => {
                acc[g] = gredList.filter(x => x === g).length;
                return acc;
            }, {});

            muridList.push({
                nama,
                kelas: row[kelasHeader],
                gp,
                counts
            });
        }
    });

    // Susun ikut GP (rendah = lebih baik)
    muridList.sort((a, b) => a.gp - b.gp);

    const top = document.getElementById("topStudentsCount").value;
    const body = document.getElementById("muridTerbaikBody");
    body.innerHTML = "";
    muridList.slice(0, top).forEach((m, i) => {
        body.innerHTML += `
          <tr class="text-center">
            <td class="px-2.5 py-2">${i + 1}</td>
            <td class="px-2.5 py-2 text-left">${m.nama}</td>
            <td class="px-2.5 py-2">${m.kelas}</td>
            <td class="px-2.5 py-2 font-bold text-blue-600">${m.gp}</td>
            ${topGradeLabels.map(g => `<td class="px-2.5 py-2">${m.counts[g] || 0}</td>`).join("")}
          </tr>`;
    });

    // =======================
    // 3. Carta & Jadual Subjek (kekal)
    // =======================
    updateGradeChartBySubject(dataTapis);
    updateSubjectAnalysis(dataTapis);

    // Tunjukkan semua kad hasil (tab 1)
    document
        .querySelectorAll('[data-tab-panel="keseluruhan"][data-reveal]')
        .forEach(p => p.classList.remove('hidden'));
}

                function updateGradeChartBySubject(dataTapis) {
                    const ctx = document.getElementById("gradeChart").getContext("2d");

                    let subjects = [...new Set(subjectColumns.map(c => c.split(" ")[0]))]
                        .filter(s => s.toUpperCase() !== "GRED" && s !== "G");
                    subjects = filterSubjectsByBidang(subjects);

                    const countsPerSubject = {};
                    subjects.forEach(sub => {
                        countsPerSubject[sub] = Object.fromEntries(chartGradeLabels.map(g => [g, 0]))
                    });

                    dataTapis.forEach(row => {
                        subjectColumns.forEach(col => {
                            const gred = row[col]?.trim().toUpperCase();
                            if (gradeValueMapping.hasOwnProperty(gred)) {
                                const subjek = col.split(" ")[0];
                                if (subjek.toUpperCase() !== "GRED" && subjek !== "G" && subjects.includes(subjek)) {
                                    countsPerSubject[subjek][gred]++;
                                }
                            }
                        });
                    });

                    const datasets = chartGradeLabels.map(g => ({
                        label: g,
                        data: subjects.map(sub => countsPerSubject[sub][g]),
                        backgroundColor: gradeColors[g],
                        stack: "s"
                    }));

                    if (gradeChartInstance) gradeChartInstance.destroy();
                    gradeChartInstance = new Chart(ctx, {
                        type: "bar",
                        data: {
                            labels: subjects.map(s => `[${s}]`),
                            datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: "top"
                                }
                            },
                            scales: {
                                x: {
                                    stacked: true
                                },
                                y: {
                                    stacked: true
                                }
                            }
                        }
                    });
                }

                function updateSubjectAnalysis(dataTapis) {
                    let subjects = [...new Set(subjectColumns.map(c => c.split(" ")[0]))]
                        .filter(s => s.toUpperCase() !== "GRED" && s !== "G");
                    subjects = filterSubjectsByBidang(subjects);

                    subjectStatsCurrent = subjects.map(sub => {
                        let counts = Object.fromEntries(chartGradeLabels.map(g => [g, 0]));
                        let hadir = 0,
                            th = 0,
                            totalNilai = 0;
                        dataTapis.forEach(row => {
                            const col = subjectColumns.find(c => c.startsWith(sub + " "));
                            const gred = row[col]?.toUpperCase();
                            if (gradeValueMapping.hasOwnProperty(gred)) {
                                counts[gred]++;
                                hadir++;
                                totalNilai += gradeValueMapping[gred];
                            } else if (gred === "TH") {
                                th++;
                            }
                        });
                        const lulus = hadir - (counts["G"] || 0);
                        const gagal = (counts["G"] || 0);
                        const peratusLulus = hadir ? ((lulus / hadir) * 100).toFixed(1) : "0.0";
                        const peratusGagal = hadir ? ((gagal / hadir) * 100).toFixed(1) : "0.0";
                        const gpmp = hadir ? (totalNilai / hadir).toFixed(2) : "--";
                        return {
                            sub,
                            counts,
                            hadir,
                            th,
                            peratusLulus,
                            peratusGagal,
                            gpmp
                        };
                    });

                    subjectStatsOriginal = [...subjectStatsCurrent];
                    renderSubjectTable();
                }

                function renderSubjectTable() {
                    const body = document.getElementById("analisisSubjekBody");
                    body.innerHTML = "";
                    let stats = [...subjectStatsCurrent];

                    if (gpmpSortState === "asc") {
                        stats.sort((a, b) => (parseFloat(a.gpmp) || 99) - (parseFloat(b.gpmp) || 99));
                    } else if (gpmpSortState === "desc") {
                        stats.sort((a, b) => (parseFloat(b.gpmp) || -1) - (parseFloat(a.gpmp) || -1));
                    } else {
                        stats = [...subjectStatsOriginal];
                    }

                    stats.forEach(s => {
                        const label = subjectNameMap[s.sub] ? `[${s.sub}] - ${subjectNameMap[s.sub]}` : s.sub;
                        body.innerHTML += `
                  <tr class="text-center">
                    <td class="px-2.5 py-2 text-left font-medium">${label}</td>
                    <td class="px-2.5 py-2 text-blue-600">${s.hadir}</td>
                    <td class="px-2.5 py-2">${s.th}</td>
                    ${chartGradeLabels.map(g=>{
                      const cls=(g==="A+"||g==="A"||g==="A-")?"bg-green-50":(g==="B+"||g==="B")?"bg-yellow-50":"bg-red-50";
                      return `<td class="px-2.5 py-2 ${cls}">${s.counts[g]}</td>`;
                    }).join("")}
                    <td class="px-2.5 py-2 text-green-600 font-medium">${s.peratusLulus}%</td>
                    <td class="px-2.5 py-2 text-red-600 font-medium">${s.peratusGagal}%</td>
                    <td class="px-2.5 py-2 text-purple-600 font-bold">${s.gpmp}</td>
                  </tr>`;
                    });
                }

                // Toggle sort GPMP (subjek)
                document.getElementById("gpmpSortBtn").addEventListener("click", () => {
                    if (gpmpSortState === "none") {
                        gpmpSortState = "asc";
                    } else if (gpmpSortState === "asc") {
                        gpmpSortState = "desc";
                    } else {
                        gpmpSortState = "none";
                    }
                    document.getElementById("gpmpSortBtn").classList.remove("asc", "desc");
                    if (gpmpSortState !== "none") {
                        document.getElementById("gpmpSortBtn").classList.add(gpmpSortState);
                    }
                    renderSubjectTable();
                });
/* =========================================================
   TAB 2: Analisis Mata Pelajaran
   - Pecahan Kelas + Sort GPMP
   - Senarai Murid + Paging + Sort Markah & Gred ‚úÖ
   ========================================================= */

// ============ GLOBAL STATES (WAJIB ADA) ============
let gpmpKelasSortState = "none";  // "none" | "asc" | "desc"
let markahSortState    = "none";  // "none" | "asc" | "desc"
let gredSortState      = "none";  // "none" | "asc" | "desc"

let pecahanKelasRowsOriginal = [];
let pecahanKelasRowsCurrent  = [];

let senaraiState = {
  rows: [],
  rowsOriginal: [],
  page: 1,
  pageSize: 5
};


// ===================================================
// 1) Jana Analisis Tab 2
// ===================================================
function generateSubjectCards() {
  const kelasTerpilih = document.getElementById('kelasFilterMP')?.value || "";
  const subjekCode    = document.getElementById('subjekFilter')?.value || "";

  // sembunyikan kad dahulu
  const cardKelas   = document.getElementById('pecahanKelasCard');
  const cardSenarai = document.getElementById('senaraiMuridCard');

  if (cardKelas)   cardKelas.classList.add('hidden');
  if (cardSenarai) cardSenarai.classList.add('hidden');

  if (!subjekCode) return;

  let data = cachedData || [];
  const kelasHeader = cariKolum("kelas");
  if (kelasTerpilih && kelasTerpilih !== "SEMUA KELAS") {
    data = data.filter(r => (r[kelasHeader] || "") === kelasTerpilih);
  }

  // RESET sort GPMP Kelas
  gpmpKelasSortState = "none";
  document.getElementById('gpmpKelasSortBtn')?.classList.remove('asc', 'desc');

  renderPecahanKelasTable(data, subjekCode);
  if (cardKelas) cardKelas.classList.remove('hidden');

  // Reset sorting & paging Senarai Murid
  markahSortState = "none";
  gredSortState   = "none";
  document.getElementById('senaraiMarkahSortBtn')?.classList.remove('asc', 'desc');
  document.getElementById('senaraiGredSortBtn')?.classList.remove('asc', 'desc');

  // Reset page size ikut dropdown (kalau user dah tukar)
  const ps = document.getElementById('senaraiPageSize')?.value;
  if (ps) {
    senaraiState.pageSize = (ps === "ALL") ? Number.POSITIVE_INFINITY : parseInt(ps, 10);
  }

  renderSenaraiMuridTable(data, subjekCode);
  if (cardSenarai) cardSenarai.classList.remove('hidden');
}


// ===================================================
// 2) Pecahan Kelas
// ===================================================
function renderPecahanKelasTable(data, subjekCode) {
  const kelasHeader = cariKolum("kelas");
  const colGred = cariKolumGredSubjek(subjekCode);
  const body = document.getElementById('pecahanKelasBody');
  body.innerHTML = "";

  if (!colGred) {
    body.innerHTML = `<tr><td class="px-3 py-3 text-sm text-red-600" colspan="16">
      Tiada kolum gred ditemui untuk subjek dipilih.</td></tr>`;
    return;
  }

  // Senarai kelas unik
  const kelasSet = new Set();
  data.forEach(r => {
    const k = (r[kelasHeader] || "").trim();
    if (k && k !== "1") kelasSet.add(k);
  });

  const kelasList = [...kelasSet].sort((a, b) => a.localeCompare(b, 'ms', { numeric: true }));

  // Struktur asas untuk setiap kelas
  const rows = kelasList.map(k => ({
    kelas: k,
    hadir: 0,
    th: 0,
    totalNilai: 0,
    counts: Object.fromEntries(chartGradeLabels.map(g => [g, 0]))
  }));

  const rowMap = Object.fromEntries(rows.map(r => [r.kelas, r]));

  // Isikan data
  data.forEach(r => {
    const k = (r[kelasHeader] || "").trim();
    if (k === "1") return;
    const g = (r[colGred] || "").toUpperCase();
    const row = rowMap[k];
    if (!row) return;

    if (gradeValueMapping.hasOwnProperty(g)) {
      row.hadir++;
      row.counts[g]++;
      row.totalNilai += gradeValueMapping[g];
    } else if (g === "TH") {
      row.th++;
    }
  });

  // Kira GPMP
  rows.forEach(r => r._gpmp = r.hadir ? (r.totalNilai / r.hadir) : null);

  // ‚úÖ Tapis hanya kelas yang ada murid ambil subjek ini
  const rowsWithData = rows.filter(r => r.hadir > 0 || r.th > 0);

  if (rowsWithData.length === 0) {
    body.innerHTML = `<tr><td colspan="16" class="px-3 py-3 text-sm text-gray-500 text-center">
      Tiada kelas mengambil subjek ini.
    </td></tr>`;
    return;
  }

  // Simpan state asal & semasa
  pecahanKelasRowsOriginal = [...rowsWithData];
  pecahanKelasRowsCurrent  = [...rowsWithData];

  drawPecahanKelasBody();
}

function drawPecahanKelasBody() {
  const body = document.getElementById('pecahanKelasBody');
  body.innerHTML = "";

  let arr = [...pecahanKelasRowsCurrent];

  if (gpmpKelasSortState === "asc") {
    arr.sort((a, b) => ((a._gpmp ?? 99) - (b._gpmp ?? 99)));
  } else if (gpmpKelasSortState === "desc") {
    arr.sort((a, b) => ((b._gpmp ?? -1) - (a._gpmp ?? -1)));
  } else {
    arr = [...pecahanKelasRowsOriginal];
  }

  arr.forEach(r => {
    const lulus = r.hadir - (r.counts["G"] || 0);
    const gagal = (r.counts["G"] || 0);
    const pLulus = r.hadir ? ((lulus / r.hadir) * 100).toFixed(1) : "0.0";
    const pGagal = r.hadir ? ((gagal / r.hadir) * 100).toFixed(1) : "0.0";
    const gpmpStr = (r._gpmp != null) ? r._gpmp.toFixed(2) : "--";

    body.innerHTML += `
      <tr class="text-gray-800 text-center">
        <td class="px-2.5 py-2 text-left font-medium">${r.kelas}</td>
        <td class="px-2.5 py-2 text-blue-600 font-medium">${r.hadir}</td>
        <td class="px-2.5 py-2">${r.th}</td>
        ${["A+","A","A-","B+","B","C+","C","D","E","G"].map(g=>{
          const cls=(g==="A+"||g==="A"||g==="A-")?"bg-green-50":(g==="B+"||g==="B")?"bg-yellow-50":"bg-red-50";
          return `<td class="px-2.5 py-2 ${cls}">${r.counts[g]||0}</td>`;
        }).join("")}
        <td class="px-2.5 py-2 text-green-600 font-medium">${pLulus}%</td>
        <td class="px-2.5 py-2 text-red-600 font-medium">${pGagal}%</td>
        <td class="px-2.5 py-2 text-purple-600 font-bold">${gpmpStr}</td>
      </tr>`;
  });
}


// ===================================================
// 3) Senarai Murid (Tab 2)
// ===================================================
function renderSenaraiMuridTable(data, subjekCode) {
  const namaHeader  = cariKolum("nama");
  const kelasHeader = cariKolum("kelas");
  const colGred     = cariKolumGredSubjek(subjekCode);
  const colMark     = cariKolumMarkahSubjek(subjekCode); // mungkin tiada dalam CSV

  const rows = [];
  data.forEach(r => {
    const kelas = (r[kelasHeader] || "").trim();
    if (kelas === "1") return; // buang kelas '1'

    const gred = (r[colGred] || "").toUpperCase();
    if (!gradeValueMapping.hasOwnProperty(gred)) return;

    const markahRaw = colMark ? (r[colMark] || "") : "";
    const markah = (markahRaw === "" || markahRaw == null) ? null : Number(markahRaw);

    rows.push({
      nama: r[namaHeader] || "",
      kelas,
      markah,
      gred
    });
  });

  // Simpan & lukis halaman pertama
  senaraiState.rows = rows;
  senaraiState.rowsOriginal = [...rows];
  senaraiState.page = 1;

  drawSenaraiMuridPage();
}

// guna sort state -> dapatkan data disusun
function getSortedSenaraiRows() {
  // Jika sort Markah aktif, keutamaan di sini; jika tidak, lihat sort Gred
  if (markahSortState !== "none") {
    const asc = (markahSortState === "asc");
    return [...senaraiState.rows].sort((a, b) => {
      const A = (a.markah == null || Number.isNaN(a.markah)) ? (asc ? Infinity : -Infinity) : a.markah;
      const B = (b.markah == null || Number.isNaN(b.markah)) ? (asc ? Infinity : -Infinity) : b.markah;
      return asc ? (A - B) : (B - A);
    });
  }

  if (gredSortState !== "none") {
    const asc = (gredSortState === "asc");
    return [...senaraiState.rows].sort((a, b) => {
      // gradeValueMapping: A+=1, A=2 ... G=10 (atau ikut mapping Cikgu)
      const A = gradeValueMapping[a.gred] ?? 999;
      const B = gradeValueMapping[b.gred] ?? 999;
      return asc ? (A - B) : (B - A);
    });
  }

  // Asal
  return [...senaraiState.rowsOriginal];
}

function drawSenaraiMuridPage() {
  const body  = document.getElementById('senaraiMuridBody');
  const info  = document.getElementById('senaraiInfo');
  const label = document.getElementById('senaraiPageLabel');

  if (!body) return;
  body.innerHTML = "";

  const sortedRows = getSortedSenaraiRows();
  const total = sortedRows.length;

  let per = senaraiState.pageSize;
  if (!Number.isFinite(per)) per = total || 1; // jika "Semua"

  const totalPages = Math.max(1, Math.ceil(total / per));
  if (senaraiState.page > totalPages) senaraiState.page = totalPages;

  const start = (senaraiState.page - 1) * per;
  const end = Math.min(start + per, total);
  const pageRows = sortedRows.slice(start, end);

  const gradeCls = (g) => {
    if (["A+", "A", "A-"].includes(g)) return "text-green-600";
    if (["B+", "B"].includes(g)) return "text-yellow-600";
    if (["C+", "C"].includes(g)) return "text-orange-500";
    return "text-red-600";
  };

  pageRows.forEach((r, i) => {
    body.innerHTML += `
      <tr>
        <td class="px-3 py-2 text-center">${start + i + 1}</td>
        <td class="px-3 py-2 text-left">${r.nama}</td>
        <td class="px-3 py-2 text-center">${r.kelas}</td>
        <td class="px-3 py-2 text-center">${(r.markah==null||Number.isNaN(r.markah)) ? "-" : r.markah}</td>
        <td class="px-3 py-2 text-center ${gradeCls(r.gred)} font-medium">${r.gred}</td>
      </tr>`;
  });

  if (info) {
    info.textContent = total
      ? `Menunjukkan ${total ? (start + 1) : 0} hingga ${end} daripada ${total} rekod`
      : `Tiada rekod ditemui`;
  }

  if (label) label.textContent = `Halaman ${senaraiState.page} daripada ${totalPages}`;

  // enable/disable prev/next
  const prevBtn = document.getElementById('senaraiPrev');
  const nextBtn = document.getElementById('senaraiNext');

  if (prevBtn) {
    if (senaraiState.page <= 1) {
      prevBtn.classList.add('opacity-50', 'pointer-events-none', 'cursor-not-allowed');
    } else {
      prevBtn.classList.remove('opacity-50', 'pointer-events-none', 'cursor-not-allowed');
    }
  }

  if (nextBtn) {
    if (senaraiState.page >= totalPages) {
      nextBtn.classList.add('opacity-50', 'pointer-events-none', 'cursor-not-allowed');
    } else {
      nextBtn.classList.remove('opacity-50', 'pointer-events-none', 'cursor-not-allowed');
    }
  }
}


// ===================================================
// 4) EVENTS (PENTING) ‚úÖ
// ===================================================

// Toggle sort GPMP Kad Pecahan Kelas
document.addEventListener('click', (e) => {
  if (e.target.closest('#gpmpKelasSortBtn')) {
    const btn = document.getElementById('gpmpKelasSortBtn');
    if (!btn) return;

    if (gpmpKelasSortState === "none") {
      gpmpKelasSortState = "asc";
      btn.classList.remove('desc');
      btn.classList.add('asc');
    } else if (gpmpKelasSortState === "asc") {
      gpmpKelasSortState = "desc";
      btn.classList.remove('asc');
      btn.classList.add('desc');
    } else {
      gpmpKelasSortState = "none";
      btn.classList.remove('asc', 'desc');
    }
    drawPecahanKelasBody();
  }
});


// ‚úÖ Toggle sort Markah & Gred Senarai Murid (INI YANG TIADA SEBELUM INI)
document.addEventListener('click', (e) => {

  // ---- SORT MARKAH ----
  if (e.target.closest('#senaraiMarkahSortBtn')) {
    const btnM = document.getElementById('senaraiMarkahSortBtn');
    const btnG = document.getElementById('senaraiGredSortBtn');
    if (!btnM || !btnG) return;

    if (markahSortState === "none") {
      markahSortState = "asc";
      btnM.classList.remove('desc');
      btnM.classList.add('asc');
    } else if (markahSortState === "asc") {
      markahSortState = "desc";
      btnM.classList.remove('asc');
      btnM.classList.add('desc');
    } else {
      markahSortState = "none";
      btnM.classList.remove('asc', 'desc');
    }

    // bila markah sort, reset gred sort
    gredSortState = "none";
    btnG.classList.remove('asc', 'desc');

    // redraw ikut sort state
    drawSenaraiMuridPage();
    return;
  }

  // ---- SORT GRED ----
  if (e.target.closest('#senaraiGredSortBtn')) {
    const btnG = document.getElementById('senaraiGredSortBtn');
    const btnM = document.getElementById('senaraiMarkahSortBtn');
    if (!btnM || !btnG) return;

    if (gredSortState === "none") {
      gredSortState = "asc";
      btnG.classList.remove('desc');
      btnG.classList.add('asc');
    } else if (gredSortState === "asc") {
      gredSortState = "desc";
      btnG.classList.remove('asc');
      btnG.classList.add('desc');
    } else {
      gredSortState = "none";
      btnG.classList.remove('asc', 'desc');
    }

    // bila gred sort, reset markah sort
    markahSortState = "none";
    btnM.classList.remove('asc', 'desc');

    // redraw ikut sort state
    drawSenaraiMuridPage();
    return;
  }
});


// Page size change (termasuk "Semua")
document.addEventListener('change', (e) => {
  if (e.target && e.target.id === 'senaraiPageSize') {
    const v = e.target.value;
    senaraiState.pageSize = (v === "ALL") ? Number.POSITIVE_INFINITY : parseInt(v, 10);
    senaraiState.page = 1;
    drawSenaraiMuridPage();
  }
});

// Prev/Next nav
document.addEventListener('click', (e) => {
  if (e.target && e.target.id === 'senaraiPrev') {
    if (senaraiState.page > 1) {
      senaraiState.page--;
      drawSenaraiMuridPage();
    }
  }

  if (e.target && e.target.id === 'senaraiNext') {
    const total = getSortedSenaraiRows().length;
    let per = senaraiState.pageSize;
    if (!Number.isFinite(per)) per = total || 1;
    const totalPages = Math.max(1, Math.ceil(total / per));
    if (senaraiState.page < totalPages) {
      senaraiState.page++;
      drawSenaraiMuridPage();
    }
  }
});

// ===================================================
// TAMBAHAN SAHAJA: Toggle sort Markah & Gred Senarai Murid (Tab 2)
// (Tidak ubah kod lain)
// ===================================================
document.addEventListener('click', (e) => {

  if (e.target.closest('#senaraiMarkahSortBtn')) {
    const btnM = document.getElementById('senaraiMarkahSortBtn');
    const btnG = document.getElementById('senaraiGredSortBtn');
    if (!btnM || !btnG) return;

    if (markahSortState === "none") {
      markahSortState = "asc";
      btnM.classList.remove('desc');
      btnM.classList.add('asc');
    } else if (markahSortState === "asc") {
      markahSortState = "desc";
      btnM.classList.remove('asc');
      btnM.classList.add('desc');
    } else {
      markahSortState = "none";
      btnM.classList.remove('asc', 'desc');
    }

    gredSortState = "none";
    btnG.classList.remove('asc', 'desc');

    drawSenaraiMuridPage();
    return;
  }

  if (e.target.closest('#senaraiGredSortBtn')) {
    const btnG = document.getElementById('senaraiGredSortBtn');
    const btnM = document.getElementById('senaraiMarkahSortBtn');
    if (!btnM || !btnG) return;

    if (gredSortState === "none") {
      gredSortState = "asc";
      btnG.classList.remove('desc');
      btnG.classList.add('asc');
    } else if (gredSortState === "asc") {
      gredSortState = "desc";
      btnG.classList.remove('asc');
      btnG.classList.add('desc');
    } else {
      gredSortState = "none";
      btnG.classList.remove('asc', 'desc');
    }

    markahSortState = "none";
    btnM.classList.remove('asc', 'desc');

    drawSenaraiMuridPage();
    return;
  }

});

                

                // =======================================================
// TAB 3: Analisis Layak Sijil (FIX "-" jadi Layak)
// =======================================================

// ‚úÖ Helper (letak sekali sahaja)
function isMissing(v){
  return v === null || v === undefined || String(v).trim() === "" || String(v).trim() === "-" || String(v).trim() === "‚Äî";
}
function norm(v){ return String(v ?? "").trim().toUpperCase(); }

// guna gradeValueMapping sedia ada untuk semak gred sah
function isValidGrade(g){
  g = norm(g);
  return !isMissing(g) && gradeValueMapping.hasOwnProperty(g);
}
function isPassedGrade(g){
  g = norm(g);
  return isValidGrade(g) && g !== "G" && g !== "TH";
}


// ====== TAB 3: Analisis Layak Sijil ======
function generateEligibilityCards() {
  if (!cachedData) return;

  const kelasHeader = cariKolum("kelas");
  const bmCol  = cariKolumGredSubjek("BM");
  const sejCol = cariKolumGredSubjek("SEJ");

  const kelasTerpilih = document.getElementById("ls-kelasFilter").value;
  const data = (!kelasTerpilih || kelasTerpilih === "SEMUA KELAS")
    ? cachedData
    : cachedData.filter(r => (r[kelasHeader] || "") === kelasTerpilih);

  let layak = 0,
      jumlah = 0,
      tiadaData = 0;

  data.forEach(row => {
    // Pastikan murid ada sekurang-kurangnya 1 gred (subjek apa pun)
    let adaGred = false;
    for (const c of subjectColumns) {
      const g = norm(row[c]);
      if (gradeValueMapping.hasOwnProperty(g)) {
        adaGred = true;
        break;
      }
    }
    if (!adaGred) return;

    const bm  = bmCol  ? row[bmCol]  : "";
    const sej = sejCol ? row[sejCol] : "";

    // ‚úÖ Jika BM/SEJ tiada data sah, jangan masuk kiraan sijil
    if (!isValidGrade(bm) || !isValidGrade(sej)) {
      tiadaData++;
      return;
    }

    // ‚úÖ Denominator sijil: hanya calon yang ada BM+SEJ sah
    jumlah++;

    // ‚úÖ Layak: BM & SEJ lulus (bukan G/TH)
    if (isPassedGrade(bm) && isPassedGrade(sej)) {
      layak++;
    }
  });

  const tidak = Math.max(0, jumlah - layak);

  // ========== 1. KAD RINGKASAN LAYAK SIJIL ==========
  document.getElementById("countLayak").textContent = layak;
  document.getElementById("countTidakLayak").textContent = tidak;
  document.getElementById("countJumlah").textContent = jumlah;

  document.getElementById("percentLayak").textContent = jumlah
    ? ((layak / jumlah) * 100).toFixed(1) + "%"
    : "0%";

  document.getElementById("percentTidak").textContent = jumlah
    ? ((tidak / jumlah) * 100).toFixed(1) + "%"
    : "0%";

  document.getElementById("kadLayakSection")?.classList.remove("hidden");

  // ========== 2. JADUAL BM & SEJ ==========
  renderBmSejTable(data); // table ini sendiri akan abaikan "-" (lihat fungsi bawah)
  document.getElementById("jadualBmSej")?.classList.remove("hidden");

  // ========== 3. JADUAL SILANG BM-SEJ ==========
  renderSilangBmSej(data); // sudah fix: skip "-"
  document.getElementById("kadSilangBmSej")?.classList.remove("hidden");

  // ========== 4. SENARAI MURID ==========
  renderSenaraiMuridLayak(data);
  document.getElementById("kadSenaraiLayak")?.classList.remove("hidden");

  // debug optional
  console.log("TAB3 LayakSijil:", { layak, tidak, jumlah, tiadaData });
}


// ‚úÖ Paparkan Senarai Murid T3
function renderSenaraiMuridLayak(data) {
  const namaHeader  = cariKolum("nama");
  const kelasHeader = cariKolum("kelas");
  const bmCol       = cariKolumMarkahSubjek("BM");
  const sejCol      = cariKolumMarkahSubjek("SEJ");
  const bmGredCol   = cariKolumGredSubjek("BM");
  const sejGredCol  = cariKolumGredSubjek("SEJ");

  const rows = [];

  data.forEach(r => {
    const nama  = (r[namaHeader]  || "").trim();
    const kelas = (r[kelasHeader] || "").trim();

    // üö´ Skip baris pelik: tiada nama, nama = nombor, atau kelas = "1"
    if (!nama || /^\d+$/.test(nama) || kelas === "1") return;

    const markBM  = bmCol  ? (r[bmCol]  || "-") : "-";
    const markSEJ = sejCol ? (r[sejCol] || "-") : "-";

    const gredBM  = bmGredCol  ? norm(r[bmGredCol]  || "-") : "-";
    const gredSEJ = sejGredCol ? norm(r[sejGredCol] || "-") : "-";

    // ‚úÖ Status (FIX: "-" tidak dianggap layak)
    let status = "Tiada Data";
    if (isValidGrade(gredBM) && isValidGrade(gredSEJ)) {
      status = (isPassedGrade(gredBM) && isPassedGrade(gredSEJ)) ? "Layak" : "Tidak Layak";
    }

    rows.push({
      nama,
      kelas,
      markBM,
      gredBM,
      markSEJ,
      gredSEJ,
      status
    });
  });

  layakState.rows = rows;
  layakState.rowsOriginal = [...rows];
  layakState.page = 1;
  drawLayakPage();
}


// =======================================================
// Jadual Silang BM-SEJ (FIX: "-" jangan masuk Lulus)
// =======================================================
function renderSilangBmSej(data) {
  const bmCol  = cariKolumGredSubjek("BM");
  const sejCol = cariKolumGredSubjek("SEJ");
  if (!bmCol || !sejCol) return;

  const counts = {
    bmLulus: { sejLulus: 0, sejGagal: 0, sejTH: 0 },
    bmGagal: { sejLulus: 0, sejGagal: 0, sejTH: 0 },
    bmTH:    { sejLulus: 0, sejGagal: 0, sejTH: 0 },
  };

  let total = 0;

  data.forEach(r => {
    const bm  = norm(r[bmCol]);
    const sej = norm(r[sejCol]);

    // ‚úÖ SKIP jika salah satu tiada data (contoh "-")
    if (!isValidGrade(bm) || !isValidGrade(sej)) return;

    const bmCat  = (bm === "G")  ? "bmGagal" : (bm === "TH") ? "bmTH" : "bmLulus";
    const sejCat = (sej === "G") ? "sejGagal" : (sej === "TH") ? "sejTH" : "sejLulus";

    counts[bmCat][sejCat]++;
    total++;
  });

  const body = document.getElementById("silangBmSejBody");
  if (!body) return;
  body.innerHTML = "";

  if (total === 0) {
    body.innerHTML = `
      <tr>
        <td colspan="5" class="px-3 py-2 text-center text-gray-500">
          Tiada data BM/SEJ yang sah untuk jadual silang.
        </td>
      </tr>`;
    return;
  }

  function row(label, c) {
    const rowTotal = c.sejLulus + c.sejGagal + c.sejTH;
    return `
      <tr class="text-center">
        <td class="px-3 py-2 text-left font-medium">${label}</td>
        <td class="px-3 py-2 text-green-600">${c.sejLulus} (${((c.sejLulus/total)*100).toFixed(1)}%)</td>
        <td class="px-3 py-2 text-red-600">${c.sejGagal} (${((c.sejGagal/total)*100).toFixed(1)}%)</td>
        <td class="px-3 py-2">${c.sejTH} (${((c.sejTH/total)*100).toFixed(1)}%)</td>
        <td class="px-3 py-2 font-bold text-blue-600 bg-yellow-50">${rowTotal} (${((rowTotal/total)*100).toFixed(1)}%)</td>
      </tr>`;
  }

  body.innerHTML += row("BM Lulus", counts.bmLulus);
  body.innerHTML += row("BM Gagal", counts.bmGagal);
  body.innerHTML += row("BM TH", counts.bmTH);

  // Jumlah keseluruhan
  const jLulus = counts.bmLulus.sejLulus + counts.bmGagal.sejLulus + counts.bmTH.sejLulus;
  const jGagal = counts.bmLulus.sejGagal + counts.bmGagal.sejGagal + counts.bmTH.sejGagal;
  const jTH    = counts.bmLulus.sejTH    + counts.bmGagal.sejTH    + counts.bmTH.sejTH;

  body.innerHTML += `
    <tr class="font-bold bg-yellow-100 text-center">
      <td class="px-3 py-2 text-left">Jumlah</td>
      <td class="px-3 py-2 text-green-600">${jLulus} (${((jLulus/total)*100).toFixed(1)}%)</td>
      <td class="px-3 py-2 text-red-600">${jGagal} (${((jGagal/total)*100).toFixed(1)}%)</td>
      <td class="px-3 py-2">${jTH} (${((jTH/total)*100).toFixed(1)}%)</td>
      <td class="px-3 py-2 text-blue-600">${total} (100.0%)</td>
    </tr>`;
}


// =======================================================
// Jadual BM & SEJ (kemas: guna helper valid grade)
// =======================================================
function renderBmSejTable(data) {
  const body = document.getElementById("bmSejBody");
  if (!body) return;
  body.innerHTML = "";

  ["BM", "SEJ"].forEach(subjek => {
    const colGred = cariKolumGredSubjek(subjek);
    if (!colGred) {
      body.innerHTML += `
        <tr>
          <td colspan="16" class="px-3 py-2 text-center text-red-600">
            Tiada data ${subjek} ditemui.
          </td>
        </tr>`;
      return;
    }

    const counts = Object.fromEntries(chartGradeLabels.map(g => [g, 0]));
    let hadir = 0, th = 0, totalNilai = 0;

    data.forEach(r => {
      const g = norm(r[colGred] || "");
      if (isValidGrade(g)) {
        counts[g] = (counts[g] || 0) + 1;
        hadir++;
        totalNilai += gradeValueMapping[g];
      } else if (g === "TH") {
        th++;
      }
    });

    const lulus = hadir - (counts["G"] || 0);
    const gagal = counts["G"] || 0;
    const pLulus = hadir ? ((lulus / hadir) * 100).toFixed(1) : "0.0";
    const pGagal = hadir ? ((gagal / hadir) * 100).toFixed(1) : "0.0";
    const gpmp = hadir ? (totalNilai / hadir).toFixed(2) : "--";

    body.innerHTML += `
      <tr class="text-center">
        <td class="px-3 py-2 font-medium text-left">
          ${subjectNameMap[subjek] || subjek}
        </td>
        <td class="px-3 py-2 text-blue-600">${hadir}</td>
        <td class="px-3 py-2">${th}</td>
        ${chartGradeLabels.map(g=>{
          const cls=(["A+","A","A-"].includes(g))?"bg-green-50":
                    (["B+","B"].includes(g))?"bg-yellow-50":"bg-red-50";
          return `<td class="px-3 py-2 ${cls}">${counts[g] || 0}</td>`;
        }).join("")}
        <td class="px-3 py-2 text-green-600 font-medium">${pLulus}%</td>
        <td class="px-3 py-2 text-red-600 font-medium">${pGagal}%</td>
        <td class="px-3 py-2 text-purple-600 font-bold">${gpmp}</td>
      </tr>`;
  });
}


// =======================================================
// Senarai Murid Layak Sijil (Tab 3) ‚Äî Paging & Sort
// =======================================================
const layakState = {
  rows: [],
  rowsOriginal: [],
  page: 1,
  pageSize: 5
};

let layakBmMarkahSortState = "none";
let layakSejMarkahSortState = "none";
let layakStatusSortState = "none";

function getSortedLayakRows() {
  let rows = [...layakState.rows];

  if (layakBmMarkahSortState !== "none") {
    const asc = (layakBmMarkahSortState === "asc");
    return rows.sort((a, b) => {
      const A = (a.markBM === "-" ? (asc ? Infinity : -Infinity) : Number(a.markBM));
      const B = (b.markBM === "-" ? (asc ? Infinity : -Infinity) : Number(b.markBM));
      return asc ? A - B : B - A;
    });
  }

  if (layakSejMarkahSortState !== "none") {
    const asc = (layakSejMarkahSortState === "asc");
    return rows.sort((a, b) => {
      const A = (a.markSEJ === "-" ? (asc ? Infinity : -Infinity) : Number(a.markSEJ));
      const B = (b.markSEJ === "-" ? (asc ? Infinity : -Infinity) : Number(b.markSEJ));
      return asc ? A - B : B - A;
    });
  }

  if (layakStatusSortState !== "none") {
    const asc = (layakStatusSortState === "asc");
    return rows.sort((a, b) =>
      asc ? a.status.localeCompare(b.status) : b.status.localeCompare(a.status)
    );
  }

  return rows;
}

function drawLayakPage() {
  const body  = document.getElementById("senaraiLayakBody");
  const info  = document.getElementById("layakInfo");
  const label = document.getElementById("layakPageLabel");
  if (!body || !info || !label) return;

  body.innerHTML = "";

  const sortedRows = getSortedLayakRows();
  const total = sortedRows.length;

  let per = layakState.pageSize;
  if (!Number.isFinite(per)) per = total || 1;

  const totalPages = Math.max(1, Math.ceil(total / per));
  if (layakState.page > totalPages) layakState.page = totalPages;

  const start = (layakState.page - 1) * per;
  const end = Math.min(start + per, total);
  const pageRows = sortedRows.slice(start, end);

  pageRows.forEach((m, i) => {
    const statusHtml =
      (m.status === "Layak")
        ? `<span class="text-green-600 font-medium">‚úî Layak</span>`
        : (m.status === "Tidak Layak")
          ? `<span class="text-red-600 font-medium">‚úò Tidak Layak</span>`
          : `<span class="text-gray-500 font-medium">Tiada Data</span>`;

    body.innerHTML += `
      <tr>
        <td class="px-3 py-2 text-center">${start + i + 1}</td>
        <td class="px-3 py-2 text-left">${m.nama}</td>
        <td class="px-3 py-2 text-center">${m.kelas}</td>
        <td class="px-3 py-2 text-center">${m.markBM}</td>
        <td class="px-3 py-2 text-center">${m.gredBM}</td>
        <td class="px-3 py-2 text-center">${m.markSEJ}</td>
        <td class="px-3 py-2 text-center">${m.gredSEJ}</td>
        <td class="px-3 py-2 text-center">${statusHtml}</td>
      </tr>`;
  });

  info.textContent = total
    ? `Menunjukkan ${start + 1} hingga ${end} daripada ${total} rekod`
    : `Tiada rekod ditemui`;

  label.textContent = `Halaman ${layakState.page} daripada ${totalPages}`;

  const prevBtn = document.getElementById("layakPrev");
  const nextBtn = document.getElementById("layakNext");
  if (prevBtn) prevBtn.disabled = (layakState.page <= 1);
  if (nextBtn) nextBtn.disabled = (layakState.page >= totalPages);
}


// Tukar page size
document.addEventListener("change", (e) => {
  if (e.target.id === "layakPageSize") {
    const v = e.target.value;
    layakState.pageSize = (v === "ALL") ? Number.POSITIVE_INFINITY : parseInt(v, 10);
    layakState.page = 1;
    drawLayakPage();
  }
});

// Prev/Next (‚úÖ hanya sekali ‚Äî jangan duplicate)
document.addEventListener("click", (e) => {
  if (e.target.id === "layakPrev" && layakState.page > 1) {
    layakState.page--;
    drawLayakPage();
  }
  if (e.target.id === "layakNext") {
    const total = layakState.rows.length;
    let per = layakState.pageSize;
    if (!Number.isFinite(per)) per = total || 1;
    const totalPages = Math.max(1, Math.ceil(total / per));
    if (layakState.page < totalPages) {
      layakState.page++;
      drawLayakPage();
    }
  }
});


// ====== 3-laras sort (BM, SEJ, Status) ======
function resetLayakSort(except) {
  if (except !== "bm") {
    layakBmMarkahSortState = "none";
    document.getElementById("layakBmMarkahSortBtn")?.classList.remove("asc", "desc");
  }
  if (except !== "sej") {
    layakSejMarkahSortState = "none";
    document.getElementById("layakSejMarkahSortBtn")?.classList.remove("asc", "desc");
  }
  if (except !== "status") {
    layakStatusSortState = "none";
    document.getElementById("layakStatusSortBtn")?.classList.remove("asc", "desc");
  }
}

document.addEventListener("click", (e) => {
  if (e.target.closest("#layakBmMarkahSortBtn")) {
    const btn = document.getElementById("layakBmMarkahSortBtn");
    if (layakBmMarkahSortState === "none") {
      layakBmMarkahSortState = "asc";
      btn.classList.add("asc");
      btn.classList.remove("desc");
    } else if (layakBmMarkahSortState === "asc") {
      layakBmMarkahSortState = "desc";
      btn.classList.remove("asc");
      btn.classList.add("desc");
    } else {
      layakBmMarkahSortState = "none";
      btn.classList.remove("asc", "desc");
    }
    resetLayakSort("bm");
    drawLayakPage();
  }

  if (e.target.closest("#layakSejMarkahSortBtn")) {
    const btn = document.getElementById("layakSejMarkahSortBtn");
    if (layakSejMarkahSortState === "none") {
      layakSejMarkahSortState = "asc";
      btn.classList.add("asc");
      btn.classList.remove("desc");
    } else if (layakSejMarkahSortState === "asc") {
      layakSejMarkahSortState = "desc";
      btn.classList.remove("asc");
      btn.classList.add("desc");
    } else {
      layakSejMarkahSortState = "none";
      btn.classList.remove("asc", "desc");
    }
    resetLayakSort("sej");
    drawLayakPage();
  }

  if (e.target.closest("#layakStatusSortBtn")) {
    const btn = document.getElementById("layakStatusSortBtn");
    if (layakStatusSortState === "none") {
      layakStatusSortState = "asc";
      btn.classList.add("asc");
      btn.classList.remove("desc");
    } else if (layakStatusSortState === "asc") {
      layakStatusSortState = "desc";
      btn.classList.remove("asc");
      btn.classList.add("desc");
    } else {
      layakStatusSortState = "none";
      btn.classList.remove("asc", "desc");
    }
    resetLayakSort("status");
    drawLayakPage();
  }
});


                // ‚úÖ Fungsi Combat Zone - Tab 4 
                function getCombatZoneCategory(grade, gps) {
                    if (gps !== null && gps !== undefined) {
                        const gpsValue = parseFloat(gps);
                        if (gpsValue >= 0 && gpsValue <= 2.33) return 'kualiti1';
                        if (gpsValue >= 2.34 && gpsValue <= 4.00) return 'kualiti2';
                        if (gpsValue >= 4.01 && gpsValue <= 6.00) return 'pertahanan1';
                        if (gpsValue >= 6.01 && gpsValue <= 8.00) return 'pertahanan2';
                        return 'kuantiti';
                    }
                    if (['A+', 'A', 'A-'].includes(grade)) return 'kualiti1';
                    if (['B+', 'B'].includes(grade)) return 'kualiti2';
                    if (['C+', 'C'].includes(grade)) return 'pertahanan1';
                    if (['D', 'E'].includes(grade)) return 'pertahanan2';
                    if (grade === 'G' || grade === 'X' || grade === 'TH' || grade === '') return 'kuantiti';
                    return 'kuantiti';
                }

                // ‚úÖ Fungsi utama Combat Zone (gabungan baru)
                // üîπ Fungsi kategori Combat Zone baru
                function getCombatZoneCategory(grade, gps) {
                    if (gps !== null && gps !== undefined) {
                        const gpsValue = parseFloat(gps);
                        if (gpsValue >= 0 && gpsValue <= 2.33) return 'kualiti1';
                        if (gpsValue >= 2.34 && gpsValue <= 4.00) return 'kualiti2';
                        if (gpsValue >= 4.01 && gpsValue <= 6.00) return 'pertahanan1';
                        if (gpsValue >= 6.01 && gpsValue <= 8.00) return 'pertahanan2';
                        return 'kuantiti';
                    }
                    if (['A+', 'A', 'A-'].includes(grade)) return 'kualiti1';
                    if (['B+', 'B'].includes(grade)) return 'kualiti2';
                    if (['C+', 'C'].includes(grade)) return 'pertahanan1';
                    if (['D', 'E'].includes(grade)) return 'pertahanan2';
                    if (grade === 'G' || grade === 'X' || grade === 'TH' || grade === '') return 'kuantiti';
                    return 'kuantiti';
                }

                // üîπ Fungsi utama Combat Zone
                // =========================
                // TAB 4: Combat Zone
                // =========================

                // üîπ Simpan data murid untuk Tab 4
                //let muridDataCZ = [];

                // üîπ Jana semula data Combat Zone
                function generateCombatZone() {
                    if (!cachedData) return;

                    muridDataCZ = []; // reset simpanan

                    const kelasHeader = cariKolum("kelas");
                    const namaHeader = cariKolum("nama");
                    const gpCol = cariKolum("GRED PURATA");
                    const kelasTerpilih = document.getElementById("cz-kelasFilter").value || "SEMUA KELAS";
                    const subjekTerpilih = document.getElementById("cz-subjekFilter").value || "SEMUA SUBJEK";

                    const colGredSubjek = (subjekTerpilih !== "SEMUA SUBJEK") ? cariKolumGredSubjek(subjekTerpilih) : null;

                    let totals = {
                        jumlah: 0,
                        kualiti1: 0,
                        kualiti2: 0,
                        pertahanan1: 0,
                        pertahanan2: 0,
                        kuantiti: 0
                    };

                    cachedData.forEach(row => {
                        const kelas = (row[kelasHeader] || "").trim();
                        const nama = (row[namaHeader] || "").trim();
                        if (!nama || /^\d+$/.test(nama)) return;
                        if (kelasTerpilih !== "SEMUA KELAS" && kelas !== kelasTerpilih) return;

                        if (colGredSubjek) {
                            const gredSubjekVal = (row[colGredSubjek] || "").toUpperCase();
                            if (!gradeValueMapping.hasOwnProperty(gredSubjekVal) && gredSubjekVal !== "TH") return;
                        }

                        let gp = null;
                        if (gpCol) {
                            const v = (row[gpCol] || "").toString().trim();
                            const num = parseFloat(v);
                            gp = Number.isFinite(num) ? num : null;
                        }

                        let markahObj = {},
                            gredObj = {};
                        Object.keys(subjectNameMap).forEach(kod => {
                            const colMark = cariKolumMarkahSubjek(kod);
                            const colGred = cariKolumGredSubjek(kod);
                            if (colMark) markahObj[kod] = (row[colMark] || "").trim();
                            if (colGred) gredObj[kod] = (row[colGred] || "").trim().toUpperCase();
                        });

                        let gredSubjek = "";
                        if (subjekTerpilih !== "SEMUA SUBJEK" && colGredSubjek)
                            gredSubjek = (row[colGredSubjek] || "").toUpperCase();

                        let kategoriKey;
                        if (subjekTerpilih === "SEMUA SUBJEK")
                            kategoriKey = (gp !== null && gp === 0) ? "q" : getCombatZoneCategory(null, gp);
                        else
                            kategoriKey = (gp !== null && gp === 0) ? "q" : getCombatZoneCategory(gredSubjek, null);

                        muridDataCZ.push({
                            nama,
                            kelas,
                            gp,
                            markah: markahObj,
                            gred: gredObj,
                            kategori: kategoriKey
                        });

                        totals.jumlah++;
                        if (totals[kategoriKey] !== undefined) totals[kategoriKey]++;
                    });

                    // üîπ Kemas kini KPI
                    updateCard("countKualiti1", "percentKualiti1", totals.kualiti1, totals.jumlah);
                    updateCard("countKualiti2", "percentKualiti2", totals.kualiti2, totals.jumlah);
                    updateCard("countPertahanan1", "percentPertahanan1", totals.pertahanan1, totals.jumlah);
                    updateCard("countPertahanan2", "percentPertahanan2", totals.pertahanan2, totals.jumlah);
                    updateCard("countKuantiti", "percentKuantiti", totals.kuantiti, totals.jumlah);
                    document.getElementById("countJumlahCZ").textContent = totals.jumlah;

                    const kategoriTabCountMap = {
                        kualiti1: "kualiti1TabCount",
                        kualiti2: "kualiti2TabCount",
                        pertahanan1: "pertahanan1TabCount",
                        pertahanan2: "pertahanan2TabCount",
                        kuantiti: "kuantitiTabCount"
                    };
                    Object.keys(kategoriTabCountMap).forEach(k => {
                        const span = document.getElementById(kategoriTabCountMap[k]);
                        if (span) span.textContent = totals[k];
                    });

                    // ‚úÖ Paparan jadual utama (guna tbody asal)
                    const container = document.getElementById("combatZoneCategoryStudentTable");
                    if (!container) return;
                    container.innerHTML = ""; // kosongkan jadual

                    // üîπ Data kategori semasa (mengikut tab aktif)
                    const kategoriLabel = {
                        kualiti1: "üèÜ Kualiti 1",
                        kualiti2: "ü•à Kualiti 2",
                        pertahanan1: "üõ°Ô∏è Pertahanan 1",
                        pertahanan2: "‚ö†Ô∏è Pertahanan 2",
                        kuantiti: "üìä Kuantiti"
                    };

                    // Default paparan: gabung semua kategori dalam satu jadual
                    let baris = "";
                    muridDataCZ.forEach((m, i) => {
                        const gredSubjek = (subjekTerpilih !== "SEMUA SUBJEK") ? (m.gred[subjekTerpilih] || "-") : "-";
                        const markahSubjek = (subjekTerpilih !== "SEMUA SUBJEK") ? (m.markah[subjekTerpilih] || "-") : "-";
                        baris += `
              <tr>
                <td>${i + 1}</td>
                <td style="text-align:left;">${m.nama}</td>
                <td>${m.kelas}</td>
                <td>${m.gp ?? "-"}</td>
                ${subjekTerpilih !== "SEMUA SUBJEK" ? `<td>${markahSubjek}</td><td>${gredSubjek}</td>` : ""}
              </tr>`;
                    });

                    container.innerHTML = baris || `<tr><td colspan="6" class="p-4 text-gray-400 text-center">Tiada data</td></tr>`;

                    // üîπ Tunjuk semula seksyen berkaitan
                    renderCombatZoneClassBreakdown(muridDataCZ, subjekTerpilih, kelasTerpilih);
                    document.getElementById("combatZoneClassBreakdownSection")?.classList.remove("hidden");
                    document.getElementById("combatZoneCategorySection")?.classList.remove("hidden");

                    // üîπ Jana versi tersembunyi untuk cetakan penuh
                    generateAllCombatZoneTablesForPrint(muridDataCZ, subjekTerpilih);

                    // üîπ Papar semula kategori aktif supaya jadual kemas terus
                    const firstActiveTab = document.querySelector('.kategori-btn.active');
                    if (firstActiveTab) {
                        const kategori = firstActiveTab.id.replace('combatZoneTab-', '');
                        switchCombatZoneCategory(kategori);
                    } else {
                        switchCombatZoneCategory("kualiti1"); // default pertama
                    }

                }

                function generateAllCombatZoneTablesForPrint(muridDataCZ, subjekTerpilih) {
                    const existing = document.getElementById("combatZoneAllTablesForPrint");
                    if (existing) existing.remove();

                    const container = document.createElement("div");
                    container.id = "combatZoneAllTablesForPrint";
                    container.style.display = "none";

                    const kategoriLabel = {
                        kualiti1: "üèÜ Kualiti 1",
                        kualiti2: "ü•à Kualiti 2",
                        pertahanan1: "üõ°Ô∏è Pertahanan 1",
                        pertahanan2: "‚ö†Ô∏è Pertahanan 2",
                        kuantiti: "üìä Kuantiti"
                    };

                    Object.keys(kategoriLabel).forEach(kat => {
                        const list = muridDataCZ.filter(m => m.kategori === kat);
                        let rows = "";

                        if (list.length > 0) {
                            list.forEach((m, i) => {
                                const gredSubjek = (subjekTerpilih !== "SEMUA SUBJEK") ? (m.gred[subjekTerpilih] || "") : "-";
                                const markahSubjek = (subjekTerpilih !== "SEMUA SUBJEK") ? (m.markah[subjekTerpilih] || "") : "-";
                                rows += `
                  <tr>
                    <td>${i + 1}</td>
                    <td style="text-align:left;">${m.nama}</td>
                    <td>${m.kelas}</td>
                    <td>${m.gp ?? "-"}</td>
                    ${subjekTerpilih !== "SEMUA SUBJEK" ? `<td>${markahSubjek}</td><td>${gredSubjek}</td>` : ""}
                  </tr>`;
                            });
                        } else {
                            rows = `<tr><td colspan="6" class="text-gray-400">Tiada data</td></tr>`;
                        }

                        container.innerHTML += `
              <div style="margin-top:25px;">
                <h4>${kategoriLabel[kat]} (${list.length})</h4>
                <table id="combatZoneTable-${kat}">
                  <thead>
                    <tr style="background:#ede9fe;">
                      <th>Bil</th>
                      <th>Nama</th>
                      <th>Kelas</th>
                      <th>GP Murid</th>
                      ${subjekTerpilih !== "SEMUA SUBJEK" ? `<th>Markah ${subjekTerpilih}</th><th>Gred ${subjekTerpilih}</th>` : ""}
                    </tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>`;
                    });

                    document.body.appendChild(container);
                }

                // üîπ Senarai murid ikut kategori
                // =========================
                // Papar Senarai Murid
                // =========================    
                function switchCombatZoneCategory(kategori) {
                    // üîπ Tukar gaya butang aktif
                    ['kualiti1', 'kualiti2', 'pertahanan1', 'pertahanan2', 'kuantiti'].forEach(id => {
                        const btn = document.getElementById("combatZoneTab-" + id);
                        if (!btn) return;
                        if (id === kategori) {
                            btn.classList.add("bg-blue-600", "text-white", "font-semibold");
                            btn.classList.remove("bg-gray-200", "text-gray-700");
                        } else {
                            btn.classList.remove("bg-blue-600", "text-white", "font-semibold");
                            btn.classList.add("bg-gray-200", "text-gray-700");
                        }
                    });

                    const tbody = document.getElementById("combatZoneCategoryStudentTable");
                    tbody.innerHTML = "";

                    const subjekTerpilih = document.getElementById("cz-subjekFilter").value || "SEMUA SUBJEK";
                    const theadTr = document.getElementById("combatZoneCategoryHeader").querySelector("tr");

                    // ‚úÖ Mapping nama penuh ‚Üí kod subjek
                    let subjekKey = subjekTerpilih;
                    if (subjekTerpilih !== "SEMUA SUBJEK") {
                        const nameToCode = Object.keys(subjectNameMap).find(k => subjectNameMap[k] === subjekTerpilih);
                        if (nameToCode) subjekKey = nameToCode;
                    }

                    // üü¢ Buang suffix " G" jika ada
                    if (subjekKey && subjekKey.endsWith(" G")) {
                        subjekKey = subjekKey.replace(" G", "");
                    }

                    // ‚úÖ Mapping kategori (butang ‚Üí key dalam data)
                    const kategoriMap = {
                        kualiti1: 'k1',
                        kualiti2: 'k2',
                        pertahanan1: 'p1',
                        pertahanan2: 'p2',
                        kuantiti: 'q'
                    };
                    const katKey = kategoriMap[kategori] || kategori;

                    // üîπ Update header jadual ikut subjek
                    if (subjekTerpilih !== "SEMUA SUBJEK") {
                        theadTr.innerHTML = `
              <th class="px-4 py-2 text-left">Bil</th>
              <th class="px-4 py-2 text-left">Nama</th>
              <th class="px-4 py-2 text-center">Kelas</th>
              <th class="px-4 py-2 text-center">GP Murid</th>
              <th class="px-4 py-2 text-center">
                  <div class="flex items-center justify-center gap-1">
                    <span>Markah ${subjekTerpilih}</span>
                    <span class="flex flex-col leading-none">
                      <svg class="up cursor-pointer hover:fill-blue-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="9" height="9"
                        onclick="sortCombatZoneByMarkah('${subjekKey}', 'asc')">
                        <path d="M7 14l5-5 5 5z"/>
                      </svg>
                      <svg class="down cursor-pointer hover:fill-blue-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="9" height="9"
                        onclick="sortCombatZoneByMarkah('${subjekKey}', 'desc')">
                        <path d="M7 10l5 5 5-5z"/>
                      </svg>
                    </span>
                  </div>
                </th>
                
                <th class="px-4 py-2 text-center">Gred ${subjekTerpilih}</th>
                `;
                    } else {
                        theadTr.innerHTML = `
              <th class="px-4 py-2 text-left">Bil</th>
              <th class="px-4 py-2 text-left">Nama</th>
              <th class="px-4 py-2 text-center">Kelas</th>
              <th class="px-4 py-2 text-center">GP Murid</th>
            `;
                    }

                    // üîπ Ambil data ikut kategori
                    let dataTapis = muridDataCZ.filter(m => m.kategori === katKey || m.kategori === kategori);

                    if (dataTapis.length === 0) {
                        tbody.innerHTML = `
              <tr>
                <td colspan="6" class="p-4 text-gray-400 text-center">Tiada data</td>
              </tr>`;
                        return;
                    }

                    // üîπ Sorting default
                    if (subjekTerpilih === "SEMUA SUBJEK") {
                        dataTapis.sort((a, b) => {
                            const gpA = parseFloat(a.gp);
                            const gpB = parseFloat(b.gp);
                            if (gpA === 0 && gpB !== 0) return 1;
                            if (gpB === 0 && gpA !== 0) return -1;
                            return gpA - gpB;
                        });
                    } else {
                        const order = ["A+", "A", "A-", "B+", "B", "C+", "C", "D", "E", "G", "X", "TH", ""];
                        dataTapis.sort((a, b) => (order.indexOf(a.gred?.[subjekKey] || "") - order.indexOf(b.gred?.[subjekKey] || "")));
                    }

                    // üîπ Papar murid
                    dataTapis.forEach((m, i) => {
                        let extraCols = "";
                        if (subjekTerpilih !== "SEMUA SUBJEK") {
                            const markahVal = m.markah?.[subjekKey] ?? "-";
                            const gredVal = m.gred?.[subjekKey] ?? "-";

                            // üü¢ Tambah warna ikut gradeColors global
                            const gredColor = gradeColors[gredVal] || "#374151"; // fallback kelabu

                            extraCols = `
                <td class="px-4 py-2 text-center" data-markah="${subjekKey}">${markahVal}</td>
                <td class="px-4 py-2 text-center font-semibold" style="color:${gredColor}">
                  ${gredVal}
                </td>
              `;
                        }

                        const row = `
              <tr class="border-b text-sm">
                <td class="px-2 py-1 text-center">${i+1}</td>
                <td class="px-2 py-1">${m.nama || "-"}</td>
                <td class="px-2 py-1 text-center">${m.kelas || "-"}</td>
                <td class="px-2 py-1 text-center">${(typeof m.gp === "number") ? m.gp.toFixed(2) : "-"}</td>
                ${extraCols}
              </tr>
            `;
                        tbody.insertAdjacentHTML("beforeend", row);
                    });
                }

                // =========================
                // Sorting ASC / DESC
                // =========================
                // üîπ Fungsi sort ikut Markah (ASC / DESC)
                function sortCombatZoneByMarkah(subjekKey, order) {
                    const tbody = document.getElementById("combatZoneCategoryStudentTable");
                    let rows = Array.from(tbody.querySelectorAll("tr"));

                    rows.sort((a, b) => {
                        let valA = parseFloat(a.querySelector(`[data-markah='${subjekKey}']`)?.innerText || 0);
                        let valB = parseFloat(b.querySelector(`[data-markah='${subjekKey}']`)?.innerText || 0);
                        return order === "asc" ? valA - valB : valB - valA;
                    });

                    tbody.innerHTML = "";
                    rows.forEach(r => tbody.appendChild(r));
                }

                // ‚úÖ Fungsi kemaskini kad KPI
                function updateCard(idCount, idPercent, value, total) {
                    document.getElementById(idCount).textContent = value;
                    document.getElementById(idPercent).textContent = total > 0 ? ((value / total * 100).toFixed(1) + "%") : "0%";
                }

                // ‚úÖ Update Kad Ringkasan
                // üîπ Jadual pecahan kelas
                function renderCombatZoneClassBreakdown(data, subjekTerpilih, kelasTerpilih) {
                    const tbody = document.getElementById("combatZoneClassBreakdownTable");
                    tbody.innerHTML = "";

                    // Kumpul data ikut kelas
                    const byClass = {};
                    data.forEach(m => {
                        if (!byClass[m.kelas]) {
                            byClass[m.kelas] = {
                                jumlah: 0,
                                kualiti1: 0,
                                kualiti2: 0,
                                pertahanan1: 0,
                                pertahanan2: 0,
                                kuantiti: 0
                            };
                        }
                        byClass[m.kelas].jumlah++;
                        if (byClass[m.kelas][m.kategori] !== undefined) {
                            byClass[m.kelas][m.kategori]++;
                        }
                    });

                    // Papar ikut kelas
                    Object.entries(byClass).forEach(([kelas, d]) => {
                        const row = `
                    <tr class="border-b">
                        <td class="px-3 py-1 font-medium">${kelas}</td>
                        <td class="px-3 py-1 text-center bg-purple-50">${d.jumlah}</td>
                        <td class="px-3 py-1 text-center bg-yellow-50">${d.kualiti1}</td>
                        <td class="px-3 py-1 text-center bg-gray-50">${d.kualiti2}</td>
                        <td class="px-3 py-1 text-center bg-blue-50">${d.pertahanan1}</td>
                        <td class="px-3 py-1 text-center bg-orange-50">${d.pertahanan2}</td>
                        <td class="px-3 py-1 text-center bg-pink-50">${d.kuantiti}</td>
                    </tr>
                `;
                        tbody.insertAdjacentHTML("beforeend", row);
                    });

                    // Tambah baris Grand Total
                    const total = Object.values(byClass).reduce((acc, d) => {
                        acc.jumlah += d.jumlah;
                        acc.kualiti1 += d.kualiti1;
                        acc.kualiti2 += d.kualiti2;
                        acc.pertahanan1 += d.pertahanan1;
                        acc.pertahanan2 += d.pertahanan2;
                        acc.kuantiti += d.kuantiti;
                        return acc;
                    }, {
                        jumlah: 0,
                        kualiti1: 0,
                        kualiti2: 0,
                        pertahanan1: 0,
                        pertahanan2: 0,
                        kuantiti: 0
                    });

                    const grandRow = `
                <tr class="font-semibold text-sm bg-gray-100">
                    <td class="px-3 py-1">Jumlah Keseluruhan</td>
                    <td class="px-3 py-1 text-center">${total.jumlah}</td>
                    <td class="px-3 py-1 text-center">${total.kualiti1}</td>
                    <td class="px-3 py-1 text-center">${total.kualiti2}</td>
                    <td class="px-3 py-1 text-center">${total.pertahanan1}</td>
                    <td class="px-3 py-1 text-center">${total.pertahanan2}</td>
                    <td class="px-3 py-1 text-center">${total.kuantiti}</td>
                </tr>
            `;
                    tbody.insertAdjacentHTML("beforeend", grandRow);
                }


                function cetakCombatZone() {
                    if (!muridDataCZ || muridDataCZ.length === 0) {
                        alert("Tiada data untuk dicetak. Sila klik 'Jana Analisis Combat Zone' terlebih dahulu.");
                        return;
                    }

                    const subjek = document.getElementById("cz-subjekFilter")?.value || "SEMUA SUBJEK";
                    const kelas = document.getElementById("cz-kelasFilter")?.value || "SEMUA KELAS";
                    const tarikhCetak = new Date().toLocaleDateString('ms-MY', {
                        day: '2-digit',
                        month: 'long',
                        year: 'numeric'
                    });

                    // ‚úÖ Ambil nama penuh subjek dari mapping global (subjectNameMap)
                    let subjekPaparan = "SEMUA SUBJEK";
                    if (subjek !== "SEMUA SUBJEK" && typeof subjectNameMap === "object") {
                        subjekPaparan = subjectNameMap[subjek] || subjek;
                    }

                    const kategoriLabel = {
                        kualiti1: "üèÜ Kualiti 1",
                        kualiti2: "ü•à Kualiti 2",
                        pertahanan1: "üõ°Ô∏è Pertahanan 1",
                        pertahanan2: "‚ö†Ô∏è Pertahanan 2",
                        kuantiti: "üìä Kuantiti"
                    };

                    // üîπ Bina semua jadual dari data semasa
                    let semuaJadualHTML = "";
                    Object.keys(kategoriLabel).forEach(kat => {
                        const list = muridDataCZ
                            .filter(m => m.kategori === kat)
                            .sort((a, b) => {
                                if (subjek === "SEMUA SUBJEK") {
                                    const gpA = parseFloat(a.gp) || 0;
                                    const gpB = parseFloat(b.gp) || 0;
                                    if (gpA !== gpB) return gpA - gpB; // GP kecil lebih baik
                                    return a.nama.localeCompare(b.nama);
                                }

                                // Susun ikut markah subjek jika ada
                                const markA = parseFloat(a.markah[subjek]) || 0;
                                const markB = parseFloat(b.markah[subjek]) || 0;
                                if (markB !== markA) return markB - markA;
                                return a.nama.localeCompare(b.nama);
                            });

                        if (list.length === 0) return;

                        let rows = "";
                        list.forEach((m, i) => {
                            const gredSubjek = (subjek !== "SEMUA SUBJEK") ? (m.gred[subjek] || "-") : "-";
                            const markahSubjek = (subjek !== "SEMUA SUBJEK") ? (m.markah[subjek] || "-") : "-";
                            rows += `
                    <tr>
                      <td>${i + 1}</td>
                      <td style="text-align:left;">${m.nama}</td>
                      <td>${m.kelas}</td>
                      <td>${m.gp ?? "-"}</td>
                      ${subjek !== "SEMUA SUBJEK" ? `<td>${markahSubjek}</td><td>${gredSubjek}</td>` : ""}
                    </tr>`;
                        });

                        semuaJadualHTML += `
                  <h4 style="margin-top:25px;">${kategoriLabel[kat]} (${list.length})</h4>
                  <table style="width:100%; border-collapse:collapse; font-size:13px;">
                    <thead>
                      <tr style="background:#ede9fe;">
                        <th>Bil</th>
                        <th>Nama</th>
                        <th>Kelas</th>
                        <th>GP Murid</th>
                        ${subjek !== "SEMUA SUBJEK" ? `<th>Markah ${subjek}</th><th>Gred ${subjek}</th>` : ""}
                      </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                  </table>
                `;
                    });

                    if (!semuaJadualHTML) {
                        alert("Tiada murid ditemui untuk cetakan.");
                        return;
                    }

                    // üé® Gaya cetakan rasmi
                    const style = `
                <style>
                  body { font-family: Arial, sans-serif; padding: 25px; color: #000; }
                  h2, h3, h4 { text-align: center; margin: 0; }
                  h2 { font-size: 20px; font-weight: bold; margin-top: 5px; }
                  h3 { font-size: 15px; margin-bottom: 20px; }
                  h4 { margin-top: 25px; margin-bottom: 8px; color: #333; }
                  table, th, td { border: 1px solid #000; border-collapse: collapse; }
                  table { table-layout: fixed; width: 100%; margin-bottom: 20px; }
                  th, td { padding: 6px 8px; text-align: center; font-size: 12px; }
                  th { background: #e0d7fb; font-weight: bold; }
                  tr:nth-child(even) { background: #f9f9f9; }
            
                  /* Lebar kolum tetap */
                  th:nth-child(1), td:nth-child(1) { width: 5%; }     
                  th:nth-child(2), td:nth-child(2) { width: 35%; text-align: left; } 
                  th:nth-child(3), td:nth-child(3) { width: 20%; }    
                  th:nth-child(4), td:nth-child(4) { width: 15%; }    
                  th:nth-child(5), td:nth-child(5) { width: 15%; }    
                  th:nth-child(6), td:nth-child(6) { width: 10%; }    
            
                  .info { text-align:center; font-size:11px; margin-bottom:15px; }
                  .footer { text-align:center; font-size:8px; color:#555; margin-top:40px; }
                  @page { size: A4 landscape; margin: 12mm; }
                </style>
              `;

                    // üñ®Ô∏è Cetak laporan
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                <html>
                  <head><title>Analisis Combat Zone</title>${style}</head>
                  <body>
                    <img src="https://leepie.github.io/kbs/KBs-LOGO-FINAL.png"
                         alt="Logo Sekolah" style="width:80px; display:block; margin:auto;">
                    <h2>SMK KPG BAHAGIA, TELUK INTAN, PERAK DARUL REDZUAN</h2>
                    <h3>Analisis Combat Zone (Semua Kategori)</h3>
                    <div class="info">
                      <strong>Subjek:</strong> ${subjekPaparan} &nbsp;|&nbsp;
                      <strong>Kelas:</strong> ${kelas} &nbsp;|&nbsp;
                      <strong>Tarikh Cetakan:</strong> ${tarikhCetak}
                    </div>
                    ${semuaJadualHTML}
                    <div class="footer">
                      Dicetak secara automatik daripada Sistem Analisis PPSA vs PraSPM<br>
                      ¬© 2026 Hakcipta Terpelihara XCode Mr LePaK
                    </div>
                  </body>
                </html>
              `);

                    printWindow.document.close();
                    printWindow.print();
                }
                // ================== (TAMAT SCRIPT) ==================
            </script>
            <script>
                (function() {
                    // ‚úÖ Teks
                    const REPLACEMENT_TEXT = "¬© 2026 Hakcipta Terpelihara XCode Mr LePaK";

                    // 
                    document.addEventListener("contextmenu", e => e.preventDefault());

                    // (Ctrl+C, Ctrl+U, F12, dll.)
                    document.addEventListener("keydown", function(e) {
                        if (e.key === "F12") {
                            e.preventDefault();
                            return;
                        }
                        if (e.ctrlKey || e.metaKey) {
                            const k = e.key.toLowerCase();
                            const blocked = ["c", "v", "x", "u", "s"]; // tambah jika perlu
                            const shiftReq = (e.shiftKey && (k === "i")); // Ctrl+Shift+I
                            if (blocked.includes(k) || shiftReq) {
                                e.preventDefault();
                            }
                        }
                    });

                    // Override 
                    document.addEventListener("copy", function(e) {
                        if (e.clipboardData) {
                            e.clipboardData.setData('text/plain', REPLACEMENT_TEXT);
                            e.clipboardData.setData('text/html', '<p>' + REPLACEMENT_TEXT + '</p>');
                            e.preventDefault();
                        } else if (window.clipboardData) {
                            window.clipboardData.setData('Text', REPLACEMENT_TEXT);
                            e.preventDefault();
                        }
                    });

                    // Override Paste ‚Üí tampal 
                    document.addEventListener("paste", function(e) {
                        e.preventDefault();
                        const active = document.activeElement;
                        if (active && (active.tagName === "INPUT" || active.tagName === "TEXTAREA")) {
                            active.value = REPLACEMENT_TEXT;
                            return;
                        }
                        const sel = window.getSelection();
                        if (!sel.rangeCount) return;
                        const range = sel.getRangeAt(0);
                        range.deleteContents();
                        range.insertNode(document.createTextNode(REPLACEMENT_TEXT));
                    });
                })();
            </script>
            <!-- id TAB TAB TAB-->
            <script>
                document.addEventListener("DOMContentLoaded", () => {
                    // ‚úÖ Tab 2 (Mata Pelajaran) ‚Äì syarat ketat
                    function checkTab2Enable() {
                        const kelasVal = document.getElementById("kelasFilterMP")?.value || "";
                        const subjekVal = document.getElementById("subjekFilter")?.value || "";
                        const btn = document.getElementById("btnJanaTab2");
                        if (btn) {
                            // Hanya aktif jika kelas ‚â† "" DAN subjek ‚â† ""
                            btn.disabled = (kelasVal === "" || subjekVal === "");
                        }
                    }

                    // Attach listener Tab 2
                    document.getElementById("kelasFilterMP")?.addEventListener("change", checkTab2Enable);
                    document.getElementById("subjekFilter")?.addEventListener("change", checkTab2Enable);

                    // Jalankan sekali awal-awal
                    checkTab2Enable();

                    // ‚úÖ Tab lain ikut logik asal (tak benarkan kosong "")
                    const mapping = [{
                            sel: "kelasFilter",
                            btn: "btnJana"
                        }, // Tab 1
                        {
                            sel: "ls-kelasFilter",
                            btn: "btnJanaTab3"
                        }, // Tab 3
                        {
                            sel: "cz-kelasFilter",
                            btn: "btnCombatZone"
                        } // Tab 4
                    ];

                    mapping.forEach(m => {
                        const sel = document.getElementById(m.sel);
                        const btn = document.getElementById(m.btn);
                        if (sel && btn) {
                            sel.addEventListener("change", () => {
                                btn.disabled = (sel.value === "");
                            });
                            // set default masa load
                            btn.disabled = (sel.value === "");
                        }
                    });
                });
            </script>

            <script>
                function checkKod() {
                    const kod = document.getElementById("kodSekolah").value.trim().toUpperCase();
                    const kodBetul = "TOVT4"; // ‚úÖ kod sekolah

                    if (kod === kodBetul) {
                        document.getElementById("loginOverlay").style.display = "none"; // tutup overlay
                        document.getElementById("content").style.display = "block"; // buka kandungan
                    } else {
                        document.getElementById("msg").innerText = "Kod salah! Sila cuba lagi.";
                    }
                }
            </script>

        </div>
    </body>

</html>





        
